<!DOCTYPE html>
<html lang="zh-TW" style="font-size: 1.1rem;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>藥品撥補系統 - 智慧記憶版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style type="text/tailwindcss">
        [v-cloak] { display: none; }
        body { background-color: #f1f5f9; transition: all 0.2s; }
        .calc-btn { 
            @apply flex items-center justify-center text-3xl font-black rounded-xl border-2 border-slate-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all active:shadow-none active:translate-x-[2px] active:translate-y-[2px];
            height: 75px;
        }
        .btn-num { @apply bg-white text-slate-900; }
        .btn-op { @apply bg-orange-400 text-white; }
        .btn-ac { @apply bg-red-600 text-white; }
        .btn-del { @apply bg-red-400 text-white; }
        .btn-equal { @apply bg-blue-600 text-white; }
        .btn-sign { @apply bg-slate-500 text-white; }
        .record-card { border-left: 8px solid #cbd5e1; }
        .record-card.selected { @apply bg-blue-50 border-blue-400; }
        .nav-btn { @apply bg-white border-2 border-slate-800 rounded-xl flex items-center justify-center shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-[1px] active:translate-y-[1px]; }
        .modal-overlay { @apply fixed inset-0 z-[150] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm; }
        input[type="checkbox"] { transform: scale(1.5); cursor: pointer; }
        
        .calc-container { transition: all 0.3s ease-in-out; max-height: 1000px; overflow: hidden; }
        .calc-container.hidden-calc { max-height: 0; opacity: 0; margin-top: 0; }
        
        /* 修正：搜尋建議選中樣式 */
        .suggestion-item.highlighted { 
            background-color: #dbeafe !important; /* bg-blue-100 */
            border-left: 6px solid #2563eb; /* border-blue-600 */
        }
    </style>
</head>
<body class="p-4 pb-20">
    <div id="app" class="max-w-7xl mx-auto" v-cloak>
        <header class="flex justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl border-2 border-slate-800 shadow-[5px_5px_0px_0px_rgba(0,0,0,0.1)]">
            <div class="flex items-center gap-3">
                <button @click="goBack" class="nav-btn w-12 h-12 text-xl"><i class="fa-solid fa-arrow-left"></i></button>
                <h1 class="text-2xl font-black">藥品撥補系統</h1>
            </div>
            <div class="flex gap-2">
                <button @click="changeFontSize(-0.1)" class="nav-btn px-4 py-1 font-bold">A-</button>
                <button @click="changeFontSize(0.1)" class="nav-btn px-4 py-1 font-bold">A+</button>
                <button @click="showManager = true" class="nav-btn w-12 h-12 bg-slate-800 text-white"><i class="fa-solid fa-cog"></i></button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <section class="bg-white p-6 rounded-[2rem] border-2 border-slate-800 shadow-xl space-y-5">
                <div>
                    <label class="font-bold text-slate-500 block mb-1 text-lg">撥補人員</label>
                    <select v-model="form.user" @change="saveUserPreference" class="w-full bg-slate-100 p-4 rounded-xl font-black text-xl border-2 border-slate-300">
                        <option value="值班人員">值班人員</option>
                        <option v-for="user in staffList" :key="user" :value="user">{{ user }}</option>
                    </select>
                </div>

                <div class="relative">
                    <label class="font-bold text-slate-500 block mb-1 text-lg">搜尋藥品 <span class="text-xs text-blue-500 font-normal ml-2">支援上下鍵 + Enter</span></label>
                    <div class="relative flex items-center">
                        <input v-model="searchQuery" 
                               @input="onSearchInput" 
                               @keydown.down.prevent="moveHighlight(1)"
                               @keydown.up.prevent="moveHighlight(-1)"
                               @keydown.enter.prevent="confirmSelection"
                               @keydown.esc="clearSearch"
                               placeholder="搜尋代碼或名稱..." 
                               class="w-full bg-slate-100 p-4 pr-14 rounded-xl font-black text-xl border-2 border-slate-300 outline-none focus:border-blue-500">
                        <button v-if="searchQuery" @click="clearSearch" class="absolute right-4 text-slate-400 hover:text-red-500">
                            <i class="fa-solid fa-circle-xmark text-2xl"></i>
                        </button>
                    </div>
                    
                    <div v-if="suggestions.length > 0" 
                         ref="suggestionBox"
                         class="absolute z-50 w-full bg-white shadow-2xl rounded-xl mt-2 border-2 border-slate-800 max-h-60 overflow-y-auto overflow-x-hidden">
                        <div v-for="(s, index) in suggestions" 
                             :key="s.c" 
                             :ref="el => { if (highlightIndex === index) highlightedItem = el }"
                             @click="selectDrug(s)" 
                             :class="['suggestion-item p-4 border-b border-slate-100 hover:bg-blue-50 cursor-pointer transition-colors flex justify-between items-center', highlightIndex === index ? 'highlighted' : '']">
                            <div class="pointer-events-none">
                                <div class="text-blue-600 font-bold text-sm">{{ s.c }}</div>
                                <div class="text-xl font-black">{{ s.n }}</div>
                            </div>
                            <div class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-sm font-bold border border-orange-200 pointer-events-none">
                                庫：{{ s.s || s.shelf || '?' }}
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="form.name" class="bg-blue-700 p-5 rounded-xl border-2 border-slate-800">
                    <div class="flex justify-between items-center">
                        <p class="font-black text-white text-xl">已選：[{{ form.code }}] {{ form.name }}</p>
                        <span class="bg-yellow-400 text-blue-900 px-3 py-1 rounded-full font-black text-sm border-2 border-blue-900 shadow-md">
                            儲位：{{ form.shelf || '無資料' }}
                        </span>
                    </div>
                </div>

                <div class="bg-slate-200 p-5 rounded-[2rem] border-2 border-slate-800">
                    <div class="flex justify-between items-end mb-4">
                        <label class="font-black text-slate-600 text-lg ml-2">撥補數量</label>
                        <button @click="showCalc = !showCalc" class="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border-2 border-slate-800 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] text-sm font-bold active:shadow-none active:translate-x-[1px]">
                            <i class="fa-solid" :class="showCalc ? 'fa-keyboard' : 'fa-calculator'"></i>
                            {{ showCalc ? '隱藏計算機' : '顯示計算機' }}
                        </button>
                    </div>

                    <div class="bg-white p-4 rounded-xl border-2 border-slate-800 mb-4 shadow-inner relative">
                        <div class="text-right text-4xl md:text-5xl font-black text-slate-900 overflow-x-auto py-2 min-h-[1.5em]">
                            {{ form.qtyStr || '0' }}
                        </div>
                    </div>

                    <div :class="['calc-container', { 'hidden-calc': !showCalc }]">
                        <div class="grid grid-cols-4 gap-3">
                            <button @click="form.qtyStr = ''" class="calc-btn btn-ac">AC</button>
                            <button @click="deleteLast" class="calc-btn btn-del"><i class="fa-solid fa-delete-left"></i></button>
                            <button @click="toggleSign" class="calc-btn btn-sign">+/-</button>
                            <button @click="addOp('/')" class="calc-btn btn-op">÷</button>
                            <button v-for="n in ['7','8','9']" @click="addNum(n)" class="calc-btn btn-num">{{n}}</button>
                            <button @click="addOp('*')" class="calc-btn btn-op">×</button>
                            <button v-for="n in ['4','5','6']" @click="addNum(n)" class="calc-btn btn-num">{{n}}</button>
                            <button @click="addOp('-')" class="calc-btn btn-op">-</button>
                            <button v-for="n in ['1','2','3']" @click="addNum(n)" class="calc-btn btn-num">{{n}}</button>
                            <button @click="addOp('+')" class="calc-btn btn-op">+</button>
                            <button @click="addNum('0')" class="calc-btn btn-num col-span-2">0</button>
                            <button @click="addNum('.')" class="calc-btn btn-num">.</button>
                            <button @click="calculateQty" class="calc-btn btn-equal text-5xl">=</button>
                        </div>
                    </div>
                </div>

                <button @click="submitRecord" class="w-full bg-emerald-600 text-white py-6 rounded-2xl font-black text-3xl border-4 border-slate-800 shadow-[6px_6px_0px_0px_rgba(0,0,0,0.2)]">
                    確認提交
                </button>
            </section>

            <section class="space-y-4">
                <div class="bg-white p-4 rounded-xl border-2 border-slate-800 shadow-md">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-black text-xl text-slate-600">最近紀錄</h3>
                        <input type="date" v-model="filterDate" class="p-2 border-2 border-slate-800 rounded-lg font-bold">
                    </div>
                    <div class="flex items-center justify-between bg-slate-50 p-2 rounded-lg border">
                        <label class="flex items-center gap-2 cursor-pointer font-bold ml-2">
                            <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll"> 全選
                        </label>
                        <button v-if="selectedIds.length > 0" @click="batchDelete" class="bg-red-600 text-white px-4 py-2 rounded-lg font-black text-sm">
                            刪除勾選 ({{ selectedIds.length }})
                        </button>
                    </div>
                </div>

                <div class="max-h-[600px] overflow-y-auto space-y-4 pr-2">
                    <div v-for="log in history" :key="log.id" :class="['record-card bg-white p-4 rounded-xl shadow border-2 border-slate-300 flex items-center gap-4', { 'selected': selectedIds.includes(log.id) }]">
                        <input type="checkbox" :value="log.id" v-model="selectedIds">
                        <div class="flex-1">
                            <div class="text-[0.8em] font-bold text-slate-400">
                                <span class="bg-slate-700 text-white px-2 py-0.5 rounded">{{ log.user }}</span> {{ log.time }}
                            </div>
                            <p class="font-black text-slate-900 text-xl">[{{ log.code }}] {{ log.name }}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div :class="log.qty > 0 ? 'bg-blue-600' : 'bg-orange-600'" class="text-white font-black px-4 py-2 rounded-lg text-2xl">
                                {{ log.qty > 0 ? '+' : '' }}{{ log.qty }}
                            </div>
                            <button @click="deleteSingle(log)" class="bg-red-100 text-red-600 w-12 h-12 rounded-lg flex items-center justify-center">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button @click="exportByDate" class="bg-slate-800 text-white py-4 rounded-xl font-black">
                        <i class="fa-solid fa-file-excel mr-2"></i>匯出報表
                    </button>
                    <button @click="showDeletedAudit = !showDeletedAudit" :class="showDeletedAudit ? 'bg-red-600 text-white' : 'bg-white text-red-600'" class="py-4 rounded-xl font-black border-2 border-red-600">
                        稽核紀錄
                    </button>
                </div>
            </section>
        </div>

        <div v-if="showManager" class="modal-overlay">
            <div class="bg-white w-full max-w-md rounded-3xl p-8 border-4 border-slate-800 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-black text-2xl">人員管理</h2>
                    <button @click="showManager = false" class="text-4xl">&times;</button>
                </div>
                <div class="flex gap-2 mb-6">
                    <input v-model="newStaffName" @keyup.enter="addStaff" placeholder="輸入姓名" class="flex-1 p-4 rounded-xl border-2">
                    <button @click="addStaff" class="bg-blue-600 text-white px-6 rounded-xl font-black">新增</button>
                </div>
                <div class="max-h-60 overflow-y-auto space-y-2">
                    <div v-for="(name, idx) in staffList" :key="idx" class="flex justify-between p-3 border-b">
                        <span class="font-bold">{{ name }}</span>
                        <button @click="removeStaff(idx)" class="text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { createApp, ref, computed, onMounted, onUnmounted, nextTick } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, push, remove, query, limitToLast, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZuNztwb9aLG1RqeDOyrj6KJrPhwBFi9M",
      authDomain: "fyh-pharmacy-inventory.firebaseapp.com",
      databaseURL: "https://fyh-pharmacy-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fyh-pharmacy-inventory",
      storageBucket: "fyh-pharmacy-inventory.firebasestorage.app",
      messagingSenderId: "751378148626",
      appId: "1:751378148626:web:5a2d2be1c5f905657457cb"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);

    createApp({
        setup() {
            const form = ref({ user: '值班人員', code: '', name: '', shelf: '', qtyStr: '' });
            const searchQuery = ref('');
            const warehouse = ref([]);
            const suggestions = ref([]);
            const history = ref([]);
            const staffList = ref([]);
            const showManager = ref(false);
            const showCalc = ref(true);
            const showDeletedAudit = ref(false);
            const newStaffName = ref('');
            const baseFontSize = ref(1.1);
            const filterDate = ref(new Date().toISOString().split('T')[0]);
            const selectedIds = ref([]);
            
            // 鍵盤導航索引
            const highlightIndex = ref(-1);
            const suggestionBox = ref(null);
            const highlightedItem = ref(null);

            const deleteLast = () => {
                const s = form.value.qtyStr.toString();
                form.value.qtyStr = s.length > 0 ? s.slice(0, -1) : '';
            };

            const handleKeyboard = (e) => {
                if (['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
                const key = e.key;
                if (/[0-9]/.test(key)) addNum(key);
                else if (['+', '-', '*', '/'].includes(key)) addOp(key);
                else if (key === '.') addNum('.');
                else if (key === 'Enter' || key === '=') { e.preventDefault(); calculateQty(); }
                else if (key === 'Backspace') { e.preventDefault(); deleteLast(); }
                else if (key === 'Delete' || key === 'Escape') { e.preventDefault(); form.value.qtyStr = ''; }
            };

            const saveUserPreference = () => {
                localStorage.setItem('preferred_user', form.value.user);
            };

            onMounted(() => {
                onValue(dbRef(db, "warehouse"), s => warehouse.value = s.val() ? Object.values(s.val()) : []);
                onValue(query(dbRef(db, "transfer_logs"), limitToLast(50)), s => {
                    history.value = s.val() ? Object.entries(s.val()).map(([id, v]) => ({ id, ...v })).reverse() : [];
                });
                onValue(dbRef(db, "staff_list"), s => { 
                     if (s.val()) {
                        staffList.value = s.val();
                        const savedUser = localStorage.getItem('preferred_user');
                        if (savedUser && (staffList.value.includes(savedUser) || savedUser === '值班人員')) {
                            form.value.user = savedUser;
                        }
                    }
                });
                window.addEventListener('keydown', handleKeyboard);
                
                const params = new URLSearchParams(window.location.search);
                if (params.get('code')) {
                    form.value.code = params.get('code');
                    form.value.name = params.get('name');
                    searchQuery.value = params.get('name');
                    setTimeout(() => {
                        const drug = warehouse.value.find(i => i.c === form.value.code);
                        if (drug) form.value.shelf = drug.s || drug.shelf || '無';
                    }, 1000);
                }
            });

            onUnmounted(() => window.removeEventListener('keydown', handleKeyboard));

            const onSearchInput = () => {
                highlightIndex.value = -1;
                const k = searchQuery.value.trim().toLowerCase();
                suggestions.value = k ? warehouse.value.filter(i => 
                    (i.n?.toLowerCase().includes(k) || i.c?.toLowerCase().includes(k))
                ).slice(0, 15) : []; // 稍微增加顯示數量
            };

            // 挑選移動
            const moveHighlight = (step) => {
                if (suggestions.value.length === 0) return;
                highlightIndex.value = (highlightIndex.value + step + suggestions.value.length) % suggestions.value.length;
                
                // 自動捲動確保選中的項目可見
                nextTick(() => {
                    if (highlightedItem.value && suggestionBox.value) {
                        highlightedItem.value.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                });
            };

            // 按下 Enter 確認選取
            const confirmSelection = () => {
                if (highlightIndex.value >= 0 && suggestions.value[highlightIndex.value]) {
                    selectDrug(suggestions.value[highlightIndex.value]);
                } else if (suggestions.value.length === 1) {
                    // 如果剛好只有一個結果，就算沒選也自動帶入
                    selectDrug(suggestions.value[0]);
                }
            };

            const selectDrug = (drug) => {
                form.value.code = drug.c; 
                form.value.name = drug.n; 
                form.value.shelf = drug.s || drug.shelf || '無';
                searchQuery.value = drug.n; 
                suggestions.value = [];
                highlightIndex.value = -1;
            };

            const clearSearch = () => { 
                searchQuery.value = ''; 
                suggestions.value = []; 
                highlightIndex.value = -1;
            };

            const calculateQty = () => {
                try {
                    let s = form.value.qtyStr.toString().replace(/[^0-9+\-*/().]/g, '');
                    if (['+','-','*','/'].includes(s.slice(-1))) s = s.slice(0,-1);
                    if (!s) return;
                    const res = eval(s);
                    form.value.qtyStr = (Math.round(res * 100) / 100).toString();
                } catch { 
                    form.value.qtyStr = '';
                }
            };

            const submitRecord = async () => {
                calculateQty();
                const qty = Number(form.value.qtyStr);
                if (!form.value.user || !form.value.name || isNaN(qty) || qty === 0) return alert("請檢查藥品與數量");
                const data = { 
                    time: new Date().toLocaleString('zh-TW', { hour12: false }), 
                    user: form.value.user, code: form.value.code, name: form.value.name, qty: qty 
                };
                await push(dbRef(db, "transfer_logs"), data);
                form.value.qtyStr = '';
                alert("提交成功！");
            };

            const isAllSelected = computed(() => history.value.length > 0 && selectedIds.value.length === history.value.length);
            const toggleSelectAll = () => { selectedIds.value = isAllSelected.value ? [] : history.value.map(l => l.id); };
            const toggleSign = () => {
                let s = form.value.qtyStr.toString();
                form.value.qtyStr = s.startsWith('-') ? s.substring(1) : (s && s !== '0' ? '-' + s : s);
            };
            const deleteSingle = async (log) => {
                if(!confirm("確定要刪除這筆紀錄嗎？")) return;
                const info = { dTime: new Date().toLocaleString(), by: form.value.user, old: log };
                await push(dbRef(db, "deleted_logs"), info);
                await remove(dbRef(db, `transfer_logs/${log.id}`));
            };
            const batchDelete = async () => {
                if (!confirm(`確定刪除 ${selectedIds.value.length} 筆？`)) return;
                for (const id of selectedIds.value) {
                    const log = history.value.find(l => l.id === id);
                    if (log) {
                        const info = { dTime: new Date().toLocaleString(), by: form.value.user, old: log };
                        await push(dbRef(db, "deleted_logs"), info);
                        await remove(dbRef(db, `transfer_logs/${id}`));
                    }
                }
                selectedIds.value = [];
            };
            const exportByDate = async () => {
                const snapshot = await get(dbRef(db, "transfer_logs"));
                if (!snapshot.exists()) return alert("無資料");
                const d = new Date(filterDate.value);
                const target = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
                const filtered = Object.values(snapshot.val()).filter(l => {
                    if (!l.time) return false;
                    const logDate = l.time.split(' ')[0].split('/').map(Number).join('/');
                    return logDate === target;
                });
                if (filtered.length === 0) return alert("無紀錄");
                const ws = XLSX.utils.json_to_sheet(filtered.map(l => ({ '日期時間': l.time, '人員': l.user, '代碼': l.code, '名稱': l.name, '數量': l.qty })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "撥補紀錄");
                XLSX.writeFile(wb, `撥補紀錄_${filterDate.value}.xlsx`);
            };
            const goBack = () => { window.location.href = 'search.html'; };
            const changeFontSize = (delta) => { baseFontSize.value += delta; document.documentElement.style.fontSize = `${baseFontSize.value}rem`; };
            const addStaff = () => { if (newStaffName.value.trim()) { staffList.value.push(newStaffName.value.trim()); set(dbRef(db, "staff_list"), staffList.value); newStaffName.value = ''; } };
            const removeStaff = (idx) => staffList.value.splice(idx, 1) && set(dbRef(db, "staff_list"), staffList.value);
            const addNum = (n) => form.value.qtyStr = (form.value.qtyStr === '0' ? n : form.value.qtyStr + n);
            const addOp = (op) => form.value.qtyStr += op;

            return { 
                form, searchQuery, suggestions, highlightIndex, history, staffList, 
                onSearchInput, moveHighlight, confirmSelection, selectDrug,
                calculateQty, submitRecord, goBack, filterDate, exportByDate, 
                addNum, addOp, toggleSign, changeFontSize, 
                showManager, newStaffName, addStaff, removeStaff, 
                showDeletedAudit, clearSearch, selectedIds, isAllSelected, toggleSelectAll, 
                deleteSingle, batchDelete, showCalc, deleteLast, saveUserPreference,
                suggestionBox, highlightedItem
            };
        }
    }).mount('#app');
</script>
</body>
</html>
