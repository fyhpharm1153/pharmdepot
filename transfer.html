<!DOCTYPE html>
<html lang="zh-TW" style="font-size: 1.1rem;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥å“æ’¥è£œç³»çµ± - æ ¸å¿ƒä½œæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style type="text/tailwindcss">
        [v-cloak] { display: none !important; }
        body { background-color: #f1f5f9; transition: all 0.2s; font-family: sans-serif; }
        .calc-btn { 
            @apply flex items-center justify-center text-3xl font-black rounded-xl border-2 border-slate-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all active:shadow-none active:translate-x-[2px] active:translate-y-[2px];
            height: 70px;
        }
        .btn-num { @apply bg-white text-slate-900; }
        .btn-op { @apply bg-orange-400 text-white; }
        .btn-ac { @apply bg-red-600 text-white; }
        .btn-del { @apply bg-red-400 text-white; }
        .btn-equal { @apply bg-blue-600 text-white; }
        .btn-sign { @apply bg-slate-500 text-white; }
        
        .suggestion-item.highlighted { 
            @apply bg-blue-600 text-white border-l-8 border-blue-900 scale-[1.01] z-10 font-black; 
        }
        .record-card { border-left: 8px solid #cbd5e1; }
        .modal-overlay { @apply fixed inset-0 z-[150] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm; }
        .qty-display:focus { @apply border-blue-600 ring-4 ring-blue-200 outline-none bg-blue-50; }
        
        .push-notify { 
            @apply fixed left-4 top-1/2 -translate-y-1/2 z-[200];
            @apply bg-red-600 text-white p-4 rounded-full shadow-2xl flex items-center justify-center border-2 border-white cursor-pointer hover:bg-red-700 transition-all;
            width: 70px; height: 70px;
        }
        .urgent-pulse { animation: pulse 1.2s infinite; @apply border-2 border-red-600 cursor-pointer; }
        @keyframes pulse { 0% { transform: scale(1); } 70% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="p-4 pb-20">
    <div id="app" class="max-w-7xl mx-auto" v-cloak>
        
        <div v-if="pendingUrgent.length > 0" class="push-notify animate-bounce" @click="scrollToUrgent">
            <i class="fa-solid fa-triangle-exclamation text-4xl"></i>
        </div>

        <header class="flex justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl border-2 border-slate-800 shadow-[5px_5px_0px_0px_rgba(0,0,0,0.1)]">
            <div class="flex items-center gap-3">
                <button @click="goBack" class="w-12 h-12 border-2 border-slate-800 rounded-xl bg-white flex items-center justify-center shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]"><i class="fa-solid fa-arrow-left"></i></button>
                <h1 class="text-2xl font-black text-slate-800">è—¥å“æ’¥è£œç³»çµ±</h1>
            </div>
            <div class="flex gap-2">
                <button @click="changeFontSize(-0.1)" class="px-4 py-1 border-2 border-slate-800 rounded-xl font-bold bg-white shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">A-</button>
                <button @click="changeFontSize(0.1)" class="px-4 py-1 border-2 border-slate-800 rounded-xl font-bold bg-white shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">A+</button>
                <button @click="showManager = true" class="w-12 h-12 bg-slate-800 text-white border-2 border-slate-800 rounded-xl flex items-center justify-center shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]"><i class="fa-solid fa-cog"></i></button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start mb-8 text-[1em]">
            <section class="bg-white p-6 rounded-[2rem] border-2 border-slate-800 shadow-xl space-y-5">
                <div>
                    <label class="font-bold text-slate-500 block mb-1 text-lg">æ’¥è£œäººå“¡</label>
                    <select v-model="form.user" @change="saveUserPreference" class="w-full bg-slate-100 p-4 rounded-xl font-black text-xl border-2 border-slate-300 text-slate-800">
                        <option value="å€¼ç­äººå“¡">å€¼ç­äººå“¡</option>
                        <option v-for="user in staffList" :key="user" :value="user">{{ user }}</option>
                    </select>
                </div>

                <div class="relative">
                    <label class="font-bold text-slate-500 block mb-1 text-lg">æœå°‹è—¥å“</label>
                    <div class="relative flex items-center">
                        <input v-model="searchQuery" ref="searchInput" @input="onSearchInput" 
                            @keydown.down.prevent="moveHighlight(1)" @keydown.up.prevent="moveHighlight(-1)" 
                            @keydown.enter.prevent="confirmSelection" @keydown.tab.prevent="jumpToQty" 
                            placeholder="è¼¸å…¥ä»£ç¢¼æˆ–åç¨±..." class="w-full bg-slate-100 p-4 rounded-xl font-black text-xl border-2 border-slate-300 outline-none focus:border-blue-600 transition-all">
                        <button v-if="searchQuery" @click="clearSearch" class="absolute right-4 text-slate-400 hover:text-red-500"><i class="fa-solid fa-circle-xmark text-2xl"></i></button>
                    </div>
                    <div v-if="suggestions.length > 0" class="absolute z-50 w-full bg-white shadow-2xl rounded-xl mt-2 border-2 border-slate-800 max-h-60 overflow-y-auto">
                        <div v-for="(s, index) in suggestions" :key="s.c + index" @click="selectDrug(s)" 
                            :class="['suggestion-item p-4 border-b border-slate-100 flex justify-between items-center cursor-pointer transition-all', highlightIndex === index ? 'highlighted' : '']">
                            <div>
                                <div class="text-blue-600 font-bold text-sm">{{ s.c }}</div>
                                <div class="text-xl font-black text-slate-800">{{ s.n }}</div>
                            </div>
                            <div class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-sm font-bold">å„²ä½ï¼š{{ s.s || '?' }}</div>
                        </div>
                    </div>
                </div>

                <div v-if="form.name" class="bg-blue-700 p-5 rounded-xl border-2 border-slate-800 shadow-inner space-y-3">
                    <div class="flex justify-between items-center mb-1">
                        <p class="font-black text-white text-xl">å·²é¸ï¼š[{{ form.code }}] {{ form.name }}</p>
                        <span class="bg-yellow-400 text-blue-900 px-3 py-1 rounded-full font-black text-sm border-2 border-blue-900 shadow-md">å„²ä½ï¼š{{ form.shelf || 'ç„¡' }}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="flex items-center gap-3 bg-white/10 p-3 rounded-lg border border-white/20 cursor-pointer">
                            <input type="checkbox" v-model="form.isSuperUrgent" @change="if(form.isSuperUrgent){form.isUrgent=false;form.isER=false}" class="w-6 h-6">
                            <span class="text-white font-black text-lg tracking-wider">âš¡ è¶…æ€¥</span>
                        </label>
                        <label class="flex items-center gap-3 bg-white/10 p-3 rounded-lg border border-white/20 cursor-pointer">
                            <input type="checkbox" v-model="form.isUrgent" @change="if(form.isUrgent){form.isSuperUrgent=false;form.isER=false}" class="w-6 h-6">
                            <span class="text-white font-black text-lg tracking-wider">ğŸš¨ æ€¥é ˜</span>
                        </label>
                        <label class="flex items-center gap-3 bg-white/10 p-3 rounded-lg border border-white/20 cursor-pointer">
                            <input type="checkbox" v-model="form.isER" @change="if(form.isER){form.isSuperUrgent=false;form.isUrgent=false}" class="w-6 h-6">
                            <span class="text-white font-black text-lg tracking-wider">ğŸš‘ æ€¥è¨º</span>
                        </label>
                    </div>
                </div>

                <div v-if="(!form.isUrgent && !form.isER) || form.isSuperUrgent" class="bg-slate-200 p-5 rounded-[2rem] border-2 border-slate-800">
                    <div class="flex justify-between items-center mb-4 px-2">
                        <label class="font-black text-slate-600 text-lg">æ•¸é‡</label>
                        <button @click="showCalc = !showCalc" class="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border-2 border-slate-800 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] text-xs font-bold transition-all">
                            <i class="fa-solid" :class="showCalc ? 'fa-eye-slash' : 'fa-calculator'"></i>
                            {{ showCalc ? 'é¡¯ç¤º' : 'éš±è—' }}è¨ˆç®—æ©Ÿ
                        </button>
                    </div>
                    <div ref="qtyDisplay" tabindex="0" class="qty-display bg-white p-4 rounded-xl border-2 border-slate-800 mb-4 shadow-inner text-right text-4xl font-black text-slate-900 min-h-[1.5em] transition-all">
                        {{ form.qtyStr || '0' }}
                    </div>
                    <div v-show="showCalc" class="grid grid-cols-4 gap-3">
                        <button v-for="btn in ['AC','DEL','+/-','/','7','8','9','*','4','5','6','-','1','2','3','+']" @click="handleCalcClick('form', btn)" :class="getBtnClass(btn)">{{ getBtnLabel(btn) }}</button>
                        <button @click="addNum('form','0')" class="calc-btn btn-num col-span-2">0</button>
                        <button @click="addNum('form','.')" class="calc-btn btn-num">.</button>
                        <button @click="calculate('form')" class="calc-btn btn-equal text-5xl">=</button>
                    </div>
                </div>

                <button @click="submitRecord" class="w-full bg-emerald-600 text-white py-6 rounded-2xl font-black text-3xl border-4 border-slate-800 shadow-[6px_6px_0px_0px_rgba(0,0,0,0.2)] active:translate-x-1 active:translate-y-1 transition-all">ç¢ºèªæäº¤</button>
            </section>

            <section id="historySection" class="space-y-6">
                <div v-if="pendingUrgent.length > 0" class="space-y-3">
                    <div class="flex items-center gap-2 text-red-600 font-black text-2xl"><i class="fa-solid fa-bell animate-swing"></i><h3>ç·Šæ€¥å¾…è™•ç† ({{ pendingUrgent.length }})</h3></div>
                    <div v-for="log in pendingUrgent" :key="log.id" @click="openEditModal(log)" class="urgent-pulse bg-white p-5 rounded-2xl shadow-xl flex items-center gap-4 border-2">
                        <div class="flex-1">
                            <div class="text-[0.8em] font-bold text-red-500 mb-1">
                                <span :class="log.isSuperUrgent ? 'bg-purple-600' : 'bg-red-600'" class="text-white px-2 py-0.5 rounded mr-2">{{ log.isSuperUrgent ? 'âš¡ è¶…æ€¥' : 'æ€¥ä»¶' }}</span>
                                {{ log.time }}
                            </div>
                            <p class="font-black text-slate-900 text-2xl flex flex-wrap items-center gap-2">
                                [{{ log.code }}] {{ log.name }}
                                <span class="bg-yellow-400 text-blue-900 px-3 py-0.5 rounded-full text-sm border-2 border-blue-900 shadow-sm font-black">å„²ä½ï¼š{{ log.shelf || 'ç„¡' }}</span>
                            </p>
                        </div>
                        <div :class="log.isSuperUrgent ? 'bg-purple-600' : 'bg-red-600'" class="text-white font-black px-6 py-3 rounded-xl text-2xl shadow-lg">è™•ç†</div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl border-2 border-slate-800 shadow-md flex justify-between items-center">
                    <h3 class="font-black text-xl text-slate-600">æœ€è¿‘ç´€éŒ„ <span class="text-xs font-normal opacity-60">(æœ€è¿‘20ç­†)</span></h3>
                    <input type="date" v-model="filterDate" class="p-2 border-2 border-slate-800 rounded-lg font-bold">
                </div>

                <div class="max-h-[450px] overflow-y-auto space-y-4 pr-2 border-b-2 border-slate-200 pb-4">
                    <div v-for="log in filteredHistory" :key="log.id" class="record-card bg-white p-4 rounded-xl shadow border-2 border-slate-300 flex items-center gap-4">
                        <div class="flex-1">
                            <div class="text-[0.8em] font-bold text-slate-400"><span class="bg-slate-700 text-white px-2 py-0.5 rounded mr-2">{{ log.user }}</span>{{ log.time }}</div>
                            <p class="font-black text-slate-900 text-xl leading-tight">[{{ log.code }}] {{ log.name }}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div @click="openEditModal(log)" 
                                :class="[log.isSuperUrgent ? 'bg-purple-600 text-white border-slate-800' : (log.isUrgent ? 'bg-yellow-400 text-slate-900 border-slate-800' : (log.isER ? 'bg-indigo-600 text-white' : 'bg-blue-600 text-white'))]" 
                                class="font-black px-4 py-2 rounded-lg text-2xl min-w-[90px] text-center border-2 cursor-pointer shadow-sm">
                                {{ (log.isUrgent || log.isER) && !log.isSuperUrgent && !log.processed ? (log.isER ? 'ğŸš‘' : 'ğŸš¨') : log.qty }}
                            </div>
                            <button @click.stop="deleteSingle(log)" class="bg-red-100 text-red-600 w-12 h-12 rounded-lg flex items-center justify-center border border-red-200">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button @click="exportByDate" class="w-full bg-slate-800 text-white py-5 rounded-2xl font-black text-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:translate-y-1 active:shadow-none transition-all">
                    <i class="fa-solid fa-file-excel mr-2"></i>åŒ¯å‡ºè©²æ—¥å ±è¡¨ (.xlsx)
                </button>
            </section>
        </div>

        <section class="mt-12 bg-indigo-50 p-8 rounded-[3rem] border-4 border-indigo-800 shadow-2xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div class="flex items-center gap-4 text-indigo-900 font-black text-3xl">
                    <i class="fa-solid fa-truck-medical"></i>
                    <h2>æ€¥è¨ºé ˜è—¥æ¸…å–® ({{ pendingER.length }})</h2>
                </div>
                <button @click="exportERToday" class="bg-indigo-700 text-white px-6 py-3 rounded-xl font-black shadow-lg hover:bg-indigo-800 transition-all">åŒ¯å‡ºä»Šæ—¥æ€¥è¨ºæ¸…å–® (.xlsx)</button>
            </div>
            <div v-if="pendingER.length === 0" class="text-center py-12 text-indigo-300 italic font-bold text-xl">ç›®å‰å°šç„¡æ€¥è¨ºä»¶</div>
            <div v-else class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                <div v-for="log in pendingER" :key="log.id" class="bg-white p-5 rounded-2xl shadow-md border-2 border-indigo-200 flex justify-between items-center">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-yellow-400 text-indigo-900 px-3 py-1 rounded-full text-sm font-black border-2 border-indigo-900 shadow-sm">å„²ä½ï¼š{{ log.shelf || 'ç„¡' }}</span>
                            <span class="text-xs text-indigo-400 font-bold">{{ log.time.split(' ')[1] }}</span>
                        </div>
                        <div class="text-sm font-bold text-indigo-600">{{ log.code }}</div>
                        <div class="text-xl font-black text-slate-800 leading-tight">{{ log.name }}</div>
                    </div>
                    <button @click="openEditModal(log)" class="ml-4 bg-indigo-600 text-white px-6 py-4 rounded-xl font-black text-xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">è™•ç†</button>
                </div>
            </div>
        </section>

        <div v-if="editingLog" class="modal-overlay">
            <div class="bg-white w-full max-w-md rounded-[2.5rem] p-6 border-4 border-slate-800 shadow-2xl">
                <div class="flex justify-between items-start mb-4 border-b-2 pb-2">
                    <div>
                        <h2 class="font-black text-2xl" :class="editingLog.isSuperUrgent ? 'text-purple-600' : (editingLog.isUrgent ? 'text-red-600' : (editingLog.isER ? 'text-indigo-700' : 'text-blue-700'))">
                            {{ editingLog.isSuperUrgent ? 'âš¡ è¶…æ€¥è™•ç†' : (editingLog.isUrgent ? 'ğŸš¨ æ€¥é ˜è™•ç†' : (editingLog.isER ? 'ğŸš‘ æ€¥è¨ºè™•ç†' : 'ğŸ“ ä¿®æ”¹æ•¸é‡')) }}
                        </h2>
                        <p class="font-bold text-slate-600 text-sm mt-1">{{ editingLog.name }}</p>
                    </div>
                    <button @click="editingLog = null" class="text-4xl font-black text-slate-400 hover:text-red-500 transition-colors">&times;</button>
                </div>
                <div class="bg-slate-100 p-4 rounded-2xl border-2 border-slate-800 mb-4 text-right text-5xl font-black shadow-inner">
                    {{ editQtyStr || '0' }}
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <button v-for="btn in ['AC','DEL','+/-','/','7','8','9','*','4','5','6','-','1','2','3','+']" @click="handleCalcClick('edit', btn)" :class="getBtnClass(btn)" style="height: 60px;">{{ getBtnLabel(btn) }}</button>
                    <button @click="addNum('edit','0')" class="calc-btn btn-num col-span-2" style="height: 60px;">0</button>
                    <button @click="addNum('edit','.')" class="calc-btn btn-num" style="height: 60px;">.</button>
                    <button @click="calculate('edit')" class="calc-btn btn-equal text-4xl" style="height: 60px;">=</button>
                    <div class="col-span-4 grid grid-cols-2 gap-4 mt-6">
                        <button v-if="(editingLog.isUrgent || editingLog.isSuperUrgent || editingLog.isER) && !editingLog.processed" @click="cancelUrgentIssuance" class="py-4 bg-slate-200 text-slate-600 rounded-xl font-black border-2 border-slate-400 hover:bg-slate-300">ä¸é ˜è—¥(0)</button>
                        <button @click="confirmEdit" class="py-4 bg-emerald-600 text-white rounded-xl font-black border-2 border-slate-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:bg-emerald-700 active:translate-x-[2px] active:translate-y-[2px]" :class="(editingLog.isUrgent || editingLog.isSuperUrgent || editingLog.isER) && !editingLog.processed ? '' : 'col-span-2'">ç¢ºèªç™¼æ”¾</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showManager" class="modal-overlay">
            <div class="bg-white w-full max-w-md rounded-3xl p-8 border-4 border-slate-800 shadow-2xl overflow-y-auto max-h-[90vh]">
                <div class="flex justify-between items-center mb-6"><h2 class="font-black text-2xl text-slate-800">ç³»çµ±èˆ‡èªéŸ³è¨­å®š</h2><button @click="showManager = false" class="text-4xl font-black text-slate-400">&times;</button></div>
                
                <div class="mb-8 border-b pb-6">
                    <h3 class="font-bold text-slate-500 mb-3 flex items-center gap-2"><i class="fa-solid fa-users"></i>äººå“¡ç®¡ç†</h3>
                    <div class="flex gap-2 mb-4"><input v-model="newStaffName" placeholder="è¼¸å…¥å§“å" class="flex-1 p-3 rounded-xl border-2 font-bold outline-none border-slate-300 focus:border-blue-500"><button @click="addStaff" class="bg-blue-600 text-white px-4 rounded-xl font-black text-sm active:scale-95 transition-all">æ–°å¢</button></div>
                    <div class="max-h-40 overflow-y-auto space-y-2"><div v-for="(name, idx) in staffList" :key="idx" class="flex justify-between p-3 bg-slate-50 rounded-xl border border-slate-200"><span class="font-bold text-slate-700">{{ name }}</span><button @click="removeStaff(idx)" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div></div>
                </div>

                <div class="space-y-6">
                    <h3 class="font-bold text-slate-500 mb-2 flex items-center gap-2"><i class="fa-solid fa-volume-high"></i>èªéŸ³æé†’è¨­å®š</h3>
                    
                    <div class="bg-purple-50 p-4 rounded-2xl border-2 border-purple-200 space-y-3 shadow-sm">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-purple-900">âš¡ è¶…æ€¥é ˜è¨­å®š</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="vSettings.superOn" @change="saveVSettings" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:bg-purple-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="col-span-2"><label class="text-[0.6em] font-bold text-purple-400 uppercase">èªéŸ³å…§å®¹</label><input v-model="vSettings.superText" @change="saveVSettings" placeholder="è¶…æ€¥é ˜å¿«é ˜è—¥" class="w-full p-2 rounded-lg border-2 border-purple-100 text-sm font-bold"></div>
                            <div><label class="text-[0.6em] font-bold text-purple-400 uppercase">é »ç‡(ç§’)</label><input type="number" v-model.number="vSettings.superSec" @change="saveVSettings" class="w-full p-2 rounded-lg border-2 border-purple-100 text-sm font-bold text-center"></div>
                            <div class="flex items-end"><button @click="testVoice('super')" class="w-full h-10 bg-white border-2 border-purple-400 text-purple-600 rounded-lg text-xs font-black hover:bg-purple-100 transition-all">æ¸¬è©¦ç”·è²</button></div>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-200 space-y-3 shadow-sm">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-blue-900">ğŸš¨ ä¸€èˆ¬å«è—¥è¨­å®š</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="vSettings.normalOn" @change="saveVSettings" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="col-span-2"><label class="text-[0.6em] font-bold text-blue-400 uppercase">èªéŸ³å…§å®¹</label><input v-model="vSettings.normalText" @change="saveVSettings" placeholder="ä¸€èˆ¬å«è—¥" class="w-full p-2 rounded-lg border-2 border-blue-100 text-sm font-bold"></div>
                            <div><label class="text-[0.6em] font-bold text-blue-400 uppercase">é »ç‡(ç§’)</label><input type="number" v-model.number="vSettings.normalSec" @change="saveVSettings" class="w-full p-2 rounded-lg border-2 border-blue-100 text-sm font-bold text-center"></div>
                            <div class="flex items-end"><button @click="testVoice('normal')" class="w-full h-10 bg-white border-2 border-blue-400 text-blue-600 rounded-lg text-xs font-black hover:bg-blue-100 transition-all">æ¸¬è©¦å¥³è²</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

<script type="module">
    import { createApp, ref, computed, onMounted, onUnmounted, nextTick, watch } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, push, remove, query, limitToLast, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZuNztwb9aLG1RqeDOyrj6KJrPhwBFi9M",
      authDomain: "fyh-pharmacy-inventory.firebaseapp.com",
      databaseURL: "https://fyh-pharmacy-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fyh-pharmacy-inventory",
      storageBucket: "fyh-pharmacy-inventory.firebasestorage.app",
      messagingSenderId: "751378148626",
      appId: "1:751378148626:web:5a2d2be1c5f905657457cb"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);

    createApp({
        setup() {
            const form = ref({ user: 'å€¼ç­äººå“¡', code: '', name: '', shelf: '', qtyStr: '', isUrgent: false, isSuperUrgent: false, isER: false });
            const searchQuery = ref('');
            const warehouseList = ref([]);
            const history = ref([]);
            const staffList = ref([]);
            const showManager = ref(false);
            const showCalc = ref(true);
            const editingLog = ref(null);
            const editQtyStr = ref('');
            const filterDate = ref(new Date().toISOString().split('T')[0]);
            const searchInput = ref(null);
            const qtyDisplay = ref(null);
            const suggestions = ref([]);
            const highlightIndex = ref(-1);
            const baseFontSize = ref(1.1);
            const newStaffName = ref('');

            // ğŸ“¢ èªéŸ³æ§åˆ¶èˆ‡é »ç‡
            const vSettings = ref({ 
                superOn: true, superText: 'è¶…æ€¥é ˜å¿«é ˜è—¥', superSec: 5, 
                normalOn: true, normalText: 'ä¸€èˆ¬å«è—¥', normalSec: 20 
            });

            let superTimer = null;
            let normalTimer = null;

            const speak = (text, isMale = false) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.lang = 'zh-TW';
                    utter.pitch = isMale ? 0.8 : 1.2;
                    utter.rate = 1.0;
                    window.speechSynthesis.speak(utter);
                }
            };

            const saveVSettings = () => { set(dbRef(db, "voice_config"), vSettings.value); };

            onMounted(() => {
                const params = new URLSearchParams(window.location.search);
                const pCode = params.get('code'); const pName = params.get('name'); const pType = params.get('type'); const pShelf = params.get('shelf');
                if (pCode || pName) {
                    form.value.code = pCode || ''; form.value.name = pName || ''; form.value.shelf = pShelf || 'ç„¡'; searchQuery.value = pName || '';
                    if (pType === 'urgent') form.value.isUrgent = true; if (pType === 'er') form.value.isER = true;
                    nextTick(() => jumpToQty());
                }
                onValue(dbRef(db, "voice_config"), s => { if(s.val()) vSettings.value = { ...vSettings.value, ...s.val() }; });
                onValue(dbRef(db, "warehouse"), s => { warehouseList.value = s.val() ? Object.values(s.val()).map(i => ({ c: i.c, n: i.n, s: i.s })) : []; });
                onValue(query(dbRef(db, "transfer_logs"), limitToLast(100)), s => {
                    history.value = s.val() ? Object.entries(s.val()).map(([id, v]) => ({ id, ...v })).reverse() : [];
                });
                onValue(dbRef(db, "staff_list"), s => { if(s.val()) staffList.value = s.val(); });
                window.addEventListener('keydown', handleKeyboard);
            });

            onUnmounted(() => { window.removeEventListener('keydown', handleKeyboard); clearInterval(superTimer); clearInterval(normalTimer); });

            const pendingUrgent = computed(() => history.value.filter(l => (l.isUrgent || l.isSuperUrgent) && !l.processed));
            const pendingSuper = computed(() => history.value.filter(l => l.isSuperUrgent && !l.processed));
            const pendingNormal = computed(() => history.value.filter(l => l.isUrgent && !l.isSuperUrgent && !l.processed));
            const pendingER = computed(() => history.value.filter(l => l.isER && !l.processed));
            const filteredHistory = computed(() => history.value.filter(l => (!l.isUrgent && !l.isSuperUrgent && !l.isER) || l.processed).slice(0, 20));

            // ğŸ‘ï¸ ç›£æ§ è¶…æ€¥é ˜ ç‹€æ…‹èˆ‡é »ç‡
            watch([() => pendingSuper.value.length, () => vSettings.value.superOn, () => vSettings.value.superSec], ([count, on, sec]) => {
                clearInterval(superTimer); superTimer = null;
                if (count > 0 && on) {
                    speak(vSettings.value.superText, true);
                    superTimer = setInterval(() => speak(vSettings.value.superText, true), sec * 1000);
                }
            }, { immediate: true });

            // ğŸ‘ï¸ ç›£æ§ æ€¥é ˜ ç‹€æ…‹èˆ‡é »ç‡
            watch([() => pendingNormal.value.length, () => vSettings.value.normalOn, () => vSettings.value.normalSec], ([count, on, sec]) => {
                clearInterval(normalTimer); normalTimer = null;
                if (count > 0 && on) {
                    if (pendingSuper.value.length === 0) speak(vSettings.value.normalText, false);
                    normalTimer = setInterval(() => {
                        if (pendingSuper.value.length === 0) speak(vSettings.value.normalText, false);
                    }, sec * 1000);
                }
            }, { immediate: true });

            const moveHighlight = (step) => {
                if (suggestions.value.length === 0) return;
                highlightIndex.value = (highlightIndex.value + step + suggestions.value.length) % suggestions.value.length;
                nextTick(() => { const el = document.querySelector('.suggestion-item.highlighted'); if (el) el.scrollIntoView({ block: 'nearest' }); });
            };
            const confirmSelection = () => {
                if (highlightIndex.value >= 0 && suggestions.value[highlightIndex.value]) selectDrug(suggestions.value[highlightIndex.value]);
                else if (suggestions.value.length > 0) selectDrug(suggestions.value[0]);
            };
            const selectDrug = (d) => { 
                form.value.code = d.c; form.value.name = d.n; form.value.shelf = d.s || 'ç„¡'; 
                searchQuery.value = d.n; suggestions.value = []; highlightIndex.value = -1; nextTick(() => jumpToQty()); 
            };
            const jumpToQty = () => { if (qtyDisplay.value) qtyDisplay.value.focus(); };
            const addNum = (t, n) => { if(t === 'form') form.value.qtyStr = (form.value.qtyStr === '0' ? n : form.value.qtyStr + n); else editQtyStr.value = (editQtyStr.value === '0' ? n : editQtyStr.value + n); };
            const calculate = (t) => {
                let s = t === 'form' ? form.value.qtyStr : editQtyStr.value; if (!s) return;
                try { s = s.replace(/[+\-*/]$/, ""); const res = eval(s.replace(/[^0-9+\-*/().]/g, '')); const rounded = (Math.round(res * 100) / 100).toString(); if (t === 'form') form.value.qtyStr = rounded; else editQtyStr.value = rounded;
                } catch { if (t === 'form') form.value.qtyStr = ''; else editQtyStr.value = ''; }
            };
            const handleKeyboard = (e) => {
                if (document.activeElement.tagName === 'INPUT' && document.activeElement !== searchInput.value) return;
                const target = editingLog.value ? 'edit' : 'form'; const key = e.key;
                if (/[0-9]/.test(key)) { addNum(target, key); } 
                else if (['+', '-', '*', '/'].includes(key)) { if (target === 'form') form.value.qtyStr += key; else editQtyStr.value += key; } 
                else if (key === 'Enter') { e.preventDefault(); let currentStr = target === 'form' ? form.value.qtyStr : editQtyStr.value; if (/[+\-*/]/.test(currentStr)) calculate(target); else if (!editingLog.value && form.value.name && (form.value.qtyStr || form.value.isUrgent || form.value.isSuperUrgent || form.value.isER)) submitRecord(); else if (editingLog.value) confirmEdit(); } 
                else if (key === 'Backspace') { if (document.activeElement !== searchInput.value) { e.preventDefault(); if(target === 'form') form.value.qtyStr = form.value.qtyStr.slice(0, -1); else editQtyStr.value = editQtyStr.value.slice(0, -1); } }
            };
            const submitRecord = async () => {
                if(!form.value.name) return; let q = 0;
                if((!form.value.isUrgent && !form.value.isER) || form.value.isSuperUrgent) { 
                    calculate('form'); q = Number(form.value.qtyStr); if(!q && !form.value.isSuperUrgent) return alert("è«‹è¼¸å…¥æ•¸é‡"); 
                }
                if (form.value.isSuperUrgent) speak(`è¶…æ€¥é ˜ã€‚${form.value.name}ã€‚æ•¸é‡ï¼š${q}`, true);
                await push(dbRef(db, "transfer_logs"), {
                    time: new Date().toLocaleString('zh-TW', { hour12: false }),
                    user: form.value.user, code: form.value.code, name: form.value.name, shelf: form.value.shelf,
                    qty: q, isUrgent: form.value.isUrgent, isSuperUrgent: form.value.isSuperUrgent, isER: form.value.isER, processed: false
                });
                form.value.qtyStr = ''; form.value.name = ''; searchQuery.value = ''; form.value.isUrgent = false; form.value.isSuperUrgent = false; form.value.isER = false; nextTick(() => searchInput.value.focus());
            };

            const exportERToday = async () => {
                const s = await get(dbRef(db, "transfer_logs")); if (!s.val()) return alert("å°šç„¡è³‡æ–™");
                const today = new Date().toLocaleDateString('zh-TW').split('/').map(Number).join('/');
                const logs = Object.values(s.val()).filter(l => l.isER && !l.processed && l.time.split(' ')[0].split('/').map(Number).join('/') === today);
                if (logs.length === 0) return alert("ä»Šæ—¥ç„¡å¾…è™•ç†æ€¥è¨ºä»¶");
                const data = logs.map(l => ({ 'å„²ä½': l.shelf, 'ä»£ç¢¼': l.code, 'è—¥å': l.name, 'æ™‚é–“': l.time }));
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "æ¸…å–®"); XLSX.writeFile(wb, `ä»Šæ—¥æ€¥è¨ºé ˜è—¥_${today.replace(/\//g, '-')}.xlsx`);
            };

            return {
                form, searchQuery, suggestions, highlightIndex, history, staffList, filterDate, editingLog, editQtyStr, pendingUrgent, pendingER, filteredHistory, searchInput, qtyDisplay, showManager, showCalc, newStaffName, vSettings,
                moveHighlight, confirmSelection, selectDrug, jumpToQty, addNum, calculate, submitRecord, saveVSettings, exportERToday,
                testVoice: (type) => speak(type === 'super' ? vSettings.value.superText : vSettings.value.normalText, type === 'super'),
                handleCalcClick: (target, b) => { if(b==='AC') (target==='form'?form.value.qtyStr='':editQtyStr.value=''); else if(b==='DEL') { if(target==='form') form.value.qtyStr=form.value.qtyStr.slice(0,-1); else editQtyStr.value=editQtyStr.value.slice(0,-1); } 
                    else if(b==='+/-') { let s = target==='form'?form.value.qtyStr:editQtyStr.value; s = s.startsWith('-')?s.substring(1):'-'+s; target==='form'?form.value.qtyStr=s:editQtyStr.value=s; }
                    else if(['/','*','-','+'].includes(b)) (target==='form'?form.value.qtyStr+=b:editQtyStr.value+=b);
                    else addNum(target, b); },
                onSearchInput: () => { highlightIndex.value = -1; const k = searchQuery.value.toLowerCase().trim(); suggestions.value = k ? warehouseList.value.filter(i => i.n?.toLowerCase().includes(k) || i.c?.toLowerCase().includes(k)).slice(0, 15) : []; },
                openEditModal: (log) => { editingLog.value = log; editQtyStr.value = (log.qty || 0).toString(); },
                confirmEdit: async () => { calculate('edit'); await update(dbRef(db, `transfer_logs/${editingLog.value.id}`), { qty: Number(editQtyStr.value), processed: true }); editingLog.value = null; },
                cancelUrgentIssuance: async () => { if(confirm("æ¨™è¨˜ç‚ºä¸é ˜è—¥(æ•¸é‡æ­¸é›¶)ï¼Ÿ")) { await update(dbRef(db, `transfer_logs/${editingLog.value.id}`), { qty: 0, processed: true }); editingLog.value = null; } },
                deleteSingle: async (l) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await remove(dbRef(db, `transfer_logs/${l.id}`)); },
                getBtnClass: (b) => b==='AC'?'calc-btn btn-ac':(b==='DEL'?'calc-btn btn-del':(['/','*','-','+'].includes(b)?'calc-btn btn-op':(b==='+/-'?'calc-btn btn-sign':'calc-btn btn-num'))), 
                getBtnLabel: (b) => b==='*'?'Ã—':(b==='/'?'Ã·':(b==='DEL'?'â†':b)),
                scrollToUrgent: () => document.getElementById('historySection').scrollIntoView({ behavior: 'smooth' }),
                changeFontSize: (d) => { baseFontSize.value += d; document.documentElement.style.fontSize = `${baseFontSize.value}rem`; },
                saveUserPreference: () => localStorage.setItem('preferred_user', form.value.user),
                goBack: () => window.location.href = 'search.html',
                clearSearch: () => { searchQuery.value=''; suggestions.value=[]; form.value.name=''; },
                addStaff: () => { if(newStaffName.value){ staffList.value.push(newStaffName.value); set(dbRef(db, "staff_list"), staffList.value); newStaffName.value=''; } },
                removeStaff: (i) => { staffList.value.splice(i, 1); set(dbRef(db, "staff_list"), staffList.value); },
                exportByDate: async () => {
                    const s = await get(dbRef(db, "transfer_logs")); if (!s.val()) return alert("å°šç„¡è³‡æ–™");
                    const d = new Date(filterDate.value);
                    const targetYear = d.getFullYear(); const targetMonth = d.getMonth() + 1; const targetDay = d.getDate();
                    const logs = Object.values(s.val()).filter(l => {
                        const parts = l.time.split(' ')[0].split('/');
                        return Number(parts[0]) === targetYear && Number(parts[1]) === targetMonth && Number(parts[2]) === targetDay;
                    });
                    if (logs.length === 0) return alert("è©²æ—¥ç„¡æ’¥è£œç´€éŒ„");
                    const data = logs.map(l => ({ 'æ™‚é–“': l.time, 'äººå“¡': l.user, 'ä»£ç¢¼': l.code, 'åç¨±': l.name, 'æ•¸é‡': l.qty, 'é¡å‹': l.isSuperUrgent ? 'è¶…æ€¥' : (l.isUrgent ? 'æ€¥é ˜' : (l.isER ? 'æ€¥è¨º' : 'ä¸€èˆ¬')) }));
                    const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "æ’¥è£œå ±è¡¨"); XLSX.writeFile(wb, `æ’¥è£œå ±è¡¨_${filterDate.value}.xlsx`);
                }
            };
        }
    }).mount('#app');
</script>
</body>
</html>
