<!DOCTYPE html>
<html lang="zh-TW" style="font-size: 1.1rem;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥å“æ’¥è£œç³»çµ± - å…¨åŠŸèƒ½å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style type="text/tailwindcss">
        [v-cloak] { display: none !important; }
        body { background-color: #f1f5f9; transition: all 0.2s; font-family: sans-serif; }
        .calc-btn { 
            @apply flex items-center justify-center text-3xl font-black rounded-xl border-2 border-slate-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all active:shadow-none active:translate-x-[2px] active:translate-y-[2px];
            height: 70px;
        }
        .btn-num { @apply bg-white text-slate-900; }
        .btn-op { @apply bg-orange-400 text-white; }
        .btn-ac { @apply bg-red-600 text-white; }
        .btn-del { @apply bg-red-400 text-white; }
        .btn-equal { @apply bg-blue-600 text-white; }
        .btn-sign { @apply bg-slate-500 text-white; }
        
        .urgent-pulse {
            animation: pulse 1.2s infinite;
            @apply border-2 border-red-600;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); }
        }
        .record-card { border-left: 8px solid #cbd5e1; }
        .modal-overlay { @apply fixed inset-0 z-[150] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm; }
    </style>
</head>
<body class="p-4 pb-20">
    <div id="app" class="max-w-7xl mx-auto" v-cloak>
        <header class="flex justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl border-2 border-slate-800 shadow-[5px_5px_0px_0px_rgba(0,0,0,0.1)]">
            <div class="flex items-center gap-3">
                <button @click="goBack" class="w-12 h-12 border-2 border-slate-800 rounded-xl bg-white active:bg-slate-100 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]"><i class="fa-solid fa-arrow-left"></i></button>
                <h1 class="text-2xl font-black text-slate-800">è—¥å“æ’¥è£œç³»çµ±</h1>
            </div>
            <div class="flex gap-2">
                <button @click="changeFontSize(-0.1)" class="px-4 py-1 border-2 border-slate-800 rounded-xl font-bold bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]">A-</button>
                <button @click="changeFontSize(0.1)" class="px-4 py-1 border-2 border-slate-800 rounded-xl font-bold bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]">A+</button>
                <button @click="showManager = true" class="w-12 h-12 bg-slate-800 text-white border-2 border-slate-800 rounded-xl shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]"><i class="fa-solid fa-cog"></i></button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <section class="bg-white p-6 rounded-[2rem] border-2 border-slate-800 shadow-xl space-y-5">
                <div>
                    <label class="font-bold text-slate-500 block mb-1 text-lg">æ’¥è£œäººå“¡</label>
                    <select v-model="form.user" class="w-full bg-slate-100 p-4 rounded-xl font-black text-xl border-2 border-slate-300">
                        <option value="å€¼ç­äººå“¡">å€¼ç­äººå“¡</option>
                        <option v-for="user in staffList" :key="user" :value="user">{{ user }}</option>
                    </select>
                </div>

                <div class="relative">
                    <label class="font-bold text-slate-500 block mb-1 text-lg">æœå°‹è—¥å“</label>
                    <div class="relative flex items-center">
                        <input v-model="searchQuery" @input="onSearchInput" placeholder="æœå°‹ä»£ç¢¼æˆ–åç¨±..." class="w-full bg-slate-100 p-4 rounded-xl font-black text-xl border-2 border-slate-300 outline-none">
                        <button v-if="searchQuery" @click="clearSearch" class="absolute right-4 text-slate-400"><i class="fa-solid fa-circle-xmark text-2xl"></i></button>
                    </div>
                    <div v-if="suggestions.length > 0" class="absolute z-50 w-full bg-white shadow-2xl rounded-xl mt-2 border-2 border-slate-800 max-h-60 overflow-y-auto">
                        <div v-for="s in suggestions" :key="s.c" @click="selectDrug(s)" class="p-4 border-b border-slate-100 flex justify-between items-center hover:bg-blue-50 cursor-pointer transition">
                            <div><div class="text-blue-600 font-bold text-sm">{{ s.c }}</div><div class="text-xl font-black text-slate-800">{{ s.n }}</div></div>
                            <div class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-sm font-bold border border-orange-200">åº«ï¼š{{ s.s || '?' }}</div>
                        </div>
                    </div>
                </div>

                <div v-if="form.name" class="bg-blue-700 p-5 rounded-xl border-2 border-slate-800">
                    <p class="font-black text-white text-xl mb-3">å·²é¸ï¼š[{{ form.code }}] {{ form.name }}</p>
                    <label class="flex items-center gap-3 bg-white/10 p-3 rounded-lg border border-white/20 cursor-pointer">
                        <input type="checkbox" v-model="form.isUrgent" class="w-6 h-6">
                        <span class="text-white font-black text-xl tracking-wider">ğŸš¨ æ€¥é ˜ (è—¥åº«åŠ©ç†å„ªå…ˆæ’¥è£œ)</span>
                    </label>
                </div>

                <div v-if="!form.isUrgent" class="bg-slate-200 p-5 rounded-[2rem] border-2 border-slate-800">
                    <div class="bg-white p-4 rounded-xl border-2 border-slate-800 mb-4 shadow-inner text-right text-4xl font-black text-slate-900 min-h-[1.5em]">{{ form.qtyStr || '0' }}</div>
                    <div class="grid grid-cols-4 gap-3">
                        <button @click="form.qtyStr = ''" class="calc-btn btn-ac">AC</button>
                        <button @click="deleteLast('form')" class="calc-btn btn-del"><i class="fa-solid fa-delete-left"></i></button>
                        <button @click="toggleSign('form')" class="calc-btn btn-sign">+/-</button>
                        <button @click="addOp('form','/')" class="calc-btn btn-op">Ã·</button>
                        <button v-for="n in ['7','8','9','*','4','5','6','-','1','2','3','+']" @click="isNaN(n)?addOp('form',n):addNum('form',n)" :class="['calc-btn', isNaN(n)?'btn-op':'btn-num']">{{ n === '*' ? 'Ã—' : n }}</button>
                        <button @click="addNum('form','0')" class="calc-btn btn-num col-span-2">0</button>
                        <button @click="addNum('form','.')" class="calc-btn btn-num">.</button>
                        <button @click="calculate('form')" class="calc-btn btn-equal text-5xl">=</button>
                    </div>
                </div>

                <button @click="submitRecord" class="w-full bg-emerald-600 text-white py-6 rounded-2xl font-black text-3xl border-4 border-slate-800 shadow-[6px_6px_0px_0px_rgba(0,0,0,0.2)] active:translate-x-1 active:translate-y-1 transition-all">ç¢ºèªæäº¤</button>
            </section>

            <section class="space-y-6">
                <div v-if="pendingUrgent.length > 0" class="space-y-3">
                    <div class="flex items-center gap-2 text-red-600">
                        <i class="fa-solid fa-bell animate-swing"></i>
                        <h3 class="font-black text-2xl">æ€¥é ˜å¾…è™•ç† ({{ pendingUrgent.length }})</h3>
                    </div>
                    <div class="space-y-4">
                        <div v-for="log in pendingUrgent" :key="log.id" @click="openUrgentEdit(log)" class="urgent-pulse bg-white p-5 rounded-2xl shadow-xl flex items-center gap-4 border-2 cursor-pointer transition active:scale-95">
                            <div class="flex-1">
                                <div class="text-[0.8em] font-bold text-red-500 mb-1">
                                    <span class="bg-red-600 text-white px-2 py-0.5 rounded mr-2">æ€¥ä»¶</span>{{ log.time }}
                                </div>
                                <p class="font-black text-slate-900 text-2xl">[{{ log.code }}] {{ log.name }}</p>
                                <p class="text-sm font-bold text-slate-400 mt-1">ç”³è«‹ï¼š{{ log.user }}</p>
                            </div>
                            <div class="bg-red-600 text-white font-black px-6 py-3 rounded-xl text-2xl">è™•ç†</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl border-2 border-slate-800 shadow-md flex justify-between items-center">
                    <h3 class="font-black text-xl text-slate-600">æœ€è¿‘ç´€éŒ„</h3>
                    <div class="flex gap-2">
                        <input type="date" v-model="filterDate" class="p-2 border-2 border-slate-800 rounded-lg font-bold">
                    </div>
                </div>

                <div class="max-h-[500px] overflow-y-auto space-y-4 pr-2 border-b-2 border-slate-200 pb-4">
                    <div v-for="log in filteredHistory" :key="log.id" class="record-card bg-white p-4 rounded-xl shadow border-2 border-slate-300 flex items-center gap-4">
                        <div class="flex-1">
                            <div class="text-[0.8em] font-bold text-slate-400">
                                <span class="bg-slate-700 text-white px-2 py-0.5 rounded mr-2">{{ log.user }}</span>{{ log.time }}
                            </div>
                            <p class="font-black text-slate-900 text-xl">[{{ log.code }}] {{ log.name }}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div v-if="log.isUrgent && log.processed" class="bg-yellow-400 text-slate-900 font-black px-4 py-2 rounded-lg text-2xl min-w-[90px] text-center border-2 border-slate-800">
                                {{ log.qty }}
                            </div>
                            <div v-else :class="log.qty > 0 ? 'bg-blue-600' : 'bg-orange-600'" class="text-white font-black px-4 py-2 rounded-lg text-2xl min-w-[90px] text-center">
                                {{ log.qty > 0 ? '+' : '' }}{{ log.qty }}
                            </div>
                            <button @click="deleteSingle(log)" class="bg-red-100 text-red-600 w-12 h-12 rounded-lg flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <button @click="exportByDate" class="bg-slate-800 text-white py-5 rounded-2xl font-black text-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-1">
                        <i class="fa-solid fa-file-excel mr-2"></i>åŒ¯å‡º {{ filterDate }} æ’¥è£œå ±è¡¨
                    </button>
                </div>
            </section>
        </div>

        <div v-if="editingUrgent" class="modal-overlay">
            <div class="bg-white w-full max-w-md rounded-[2.5rem] p-6 border-4 border-slate-800 shadow-2xl">
                <div class="flex justify-between items-start mb-4 border-b-2 border-slate-100 pb-2">
                    <div>
                        <h2 class="font-black text-2xl text-red-600 tracking-tighter">ğŸš¨ è™•ç†æ€¥é ˜ç´€éŒ„</h2>
                        <p class="font-bold text-slate-600 text-sm mt-1">{{ editingUrgent.name }}</p>
                    </div>
                    <button @click="editingUrgent = null" class="text-4xl font-black text-slate-400">&times;</button>
                </div>

                <div class="bg-slate-100 p-4 rounded-2xl border-2 border-slate-800 mb-4">
                    <p class="text-xs font-bold text-slate-400 mb-1 tracking-widest uppercase">å¯¦éš›æ’¥è£œæ•¸é‡</p>
                    <div class="text-right text-5xl font-black text-slate-900 min-h-[1.2em] font-mono tracking-tighter">{{ assistantQtyStr || '0' }}</div>
                </div>

                <div class="grid grid-cols-4 gap-3">
                    <button @click="assistantQtyStr = ''" class="calc-btn btn-ac h-[65px]">AC</button>
                    <button @click="deleteLast('assistant')" class="calc-btn btn-del h-[65px]"><i class="fa-solid fa-delete-left"></i></button>
                    <button @click="toggleSign('assistant')" class="calc-btn btn-sign h-[65px]">+/-</button>
                    <button @click="addOp('assistant','/')" class="calc-btn btn-op h-[65px]">Ã·</button>
                    <button v-for="n in ['7','8','9','*','4','5','6','-','1','2','3','+']" @click="isNaN(n)?addOp('assistant',n):addNum('assistant',n)" :class="['calc-btn h-[65px]', isNaN(n)?'btn-op':'btn-num']">{{ n === '*' ? 'Ã—' : n }}</button>
                    <button @click="addNum('assistant','0')" class="calc-btn btn-num col-span-2 h-[65px]">0</button>
                    <button @click="addNum('assistant','.')" class="calc-btn btn-num h-[65px]">.</button>
                    <button @click="calculate('assistant')" class="calc-btn btn-equal text-4xl h-[65px]">=</button>
                </div>

                <div class="flex gap-4 mt-8">
                    <button @click="editingUrgent = null" class="flex-1 py-4 bg-slate-200 rounded-xl font-black border-2 border-slate-300">å–æ¶ˆ</button>
                    <button @click="confirmUrgentEdit" class="flex-1 py-4 bg-emerald-600 text-white rounded-xl font-black border-2 border-slate-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-1">ç¢ºèªç™¼æ”¾</button>
                </div>
            </div>
        </div>

        <div v-if="showManager" class="modal-overlay">
            <div class="bg-white w-full max-w-md rounded-3xl p-8 border-4 border-slate-800 shadow-2xl">
                <div class="flex justify-between items-center mb-6"><h2 class="font-black text-2xl text-slate-800">äººå“¡ç®¡ç†</h2><button @click="showManager = false" class="text-4xl">&times;</button></div>
                <div class="flex gap-2 mb-6">
                    <input v-model="newStaffName" placeholder="è¼¸å…¥å§“å" class="flex-1 p-4 rounded-xl border-2 border-slate-300 font-bold focus:border-blue-500 outline-none transition">
                    <button @click="addStaff" class="bg-blue-600 text-white px-6 rounded-xl font-black shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] active:shadow-none">æ–°å¢</button>
                </div>
                <div class="max-h-60 overflow-y-auto space-y-2 border-t pt-4">
                    <div v-for="(name, idx) in staffList" :key="idx" class="flex justify-between p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <span class="font-bold text-slate-700 text-lg">{{ name }}</span>
                        <button @click="removeStaff(idx)" class="text-red-500 hover:text-red-700 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { createApp, ref, computed, onMounted, onUnmounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, push, remove, query, limitToLast, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZuNztwb9aLG1RqeDOyrj6KJrPhwBFi9M",
      authDomain: "fyh-pharmacy-inventory.firebaseapp.com",
      databaseURL: "https://fyh-pharmacy-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fyh-pharmacy-inventory",
      storageBucket: "fyh-pharmacy-inventory.firebasestorage.app",
      messagingSenderId: "751378148626",
      appId: "1:751378148626:web:5a2d2be1c5f905657457cb"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);

    createApp({
        setup() {
            const form = ref({ user: 'å€¼ç­äººå“¡', code: '', name: '', shelf: '', qtyStr: '', isUrgent: false });
            const searchQuery = ref('');
            const warehouse = ref([]);
            const suggestions = ref([]);
            const history = ref([]);
            const staffList = ref([]);
            const showManager = ref(false);
            const editingUrgent = ref(null);
            const assistantQtyStr = ref('');
            const newStaffName = ref('');
            const filterDate = ref(new Date().toISOString().split('T')[0]);
            const baseFontSize = ref(1.1);
            let lastUrgentId = null;

            // èªéŸ³æ’­æ”¾
            const speak = (text) => {
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'zh-TW';
                utter.rate = 0.95;
                window.speechSynthesis.speak(utter);
            };

            // éµç›¤ç›£è½æ ¸å¿ƒé‚è¼¯
            const handleKeyboard = (e) => {
                // å¦‚æœæ­£åœ¨è¼¸å…¥å§“åæˆ–è—¥å“æœå°‹ï¼Œä¸è§¸ç™¼è¨ˆç®—æ©Ÿ
                if (['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                    // å”¯ä¸€ä¾‹å¤–ï¼šå½ˆçª—é–‹å•Ÿæ™‚çš„è¼¸å…¥æ¡†ä¸æ‡‰è©²æ“‹ä½éµç›¤é‚è¼¯ï¼Œä½†é€™è£¡æˆ‘å€‘å½ˆçª—æ²’æ”¾ inputï¼Œæ‰€ä»¥ OK
                    return;
                }

                // åˆ¤å®šç›®å‰æ“ä½œå°è±¡ (å½ˆçª—ä¸­ or ä¸»ç•«é¢)
                const target = editingUrgent.value ? 'assistant' : 'form';
                const key = e.key;

                if (/[0-9]/.test(key)) addNum(target, key);
                else if (['+', '-', '*', '/'].includes(key)) addOp(target, key);
                else if (key === '.') addNum(target, '.');
                else if (key === 'Enter' || key === '=') { e.preventDefault(); calculate(target); }
                else if (key === 'Backspace') { e.preventDefault(); deleteLast(target); }
                else if (key === 'Delete' || key === 'Escape') { 
                    e.preventDefault(); 
                    if (target === 'form') form.value.qtyStr = ''; 
                    else assistantQtyStr.value = '';
                }
            };

            onMounted(() => {
                onValue(dbRef(db, "warehouse"), s => warehouse.value = s.val() ? Object.values(s.val()) : []);
                
                onValue(query(dbRef(db, "transfer_logs"), limitToLast(50)), s => {
                    const data = s.val() ? Object.entries(s.val()).map(([id, v]) => ({ id, ...v })) : [];
                    history.value = data.reverse();
                    
                    const latestUrgent = data.find(l => l.isUrgent && !l.processed);
                    if (latestUrgent && latestUrgent.id !== lastUrgentId) {
                        speak("æœ‰æ€¥é ˜ï¼Œè«‹é ˜è—¥");
                        lastUrgentId = latestUrgent.id;
                    }
                });

                onValue(dbRef(db, "staff_list"), s => { if(s.val()) staffList.value = s.val(); });
                window.addEventListener('keydown', handleKeyboard);
            });

            onUnmounted(() => window.removeEventListener('keydown', handleKeyboard));

            // è³‡æ–™éæ¿¾
            const filteredHistory = computed(() => history.value.filter(log => !log.isUrgent || log.processed));
            const pendingUrgent = computed(() => history.value.filter(log => log.isUrgent && !log.processed));

            // è¨ˆç®—æ©Ÿé‚è¼¯
            const addNum = (target, n) => {
                if (target === 'form') form.value.qtyStr = (form.value.qtyStr === '0' ? n : form.value.qtyStr + n);
                else assistantQtyStr.value = (assistantQtyStr.value === '0' ? n : assistantQtyStr.value + n);
            };
            const addOp = (target, op) => {
                if (target === 'form') form.value.qtyStr += op;
                else assistantQtyStr.value += op;
            };
            const deleteLast = (target) => {
                if (target === 'form') form.value.qtyStr = form.value.qtyStr.slice(0,-1);
                else assistantQtyStr.value = assistantQtyStr.value.slice(0,-1);
            };
            const toggleSign = (target) => {
                let s = target === 'form' ? form.value.qtyStr : assistantQtyStr.value;
                s = s.startsWith('-') ? s.slice(1) : (s ? '-' + s : '-');
                if (target === 'form') form.value.qtyStr = s; else assistantQtyStr.value = s;
            };
            const calculate = (target) => {
                let s = target === 'form' ? form.value.qtyStr : assistantQtyStr.value;
                try {
                    const clean = s.replace(/[^0-9+\-*/().]/g, '');
                    if (clean) {
                        const res = eval(clean);
                        const rounded = Math.round(res * 100) / 100;
                        if (target === 'form') form.value.qtyStr = rounded.toString();
                        else assistantQtyStr.value = rounded.toString();
                    }
                } catch { 
                    if (target === 'form') form.value.qtyStr = ''; else assistantQtyStr.value = '';
                }
            };

            // æ¥­å‹™é‚è¼¯
            const submitRecord = async () => {
                if (!form.value.name) return alert("è«‹é¸è—¥å“");
                let qty = 0;
                if (!form.value.isUrgent) {
                    calculate('form');
                    qty = Number(form.value.qtyStr);
                    if (!qty) return alert("è«‹è¼¸å…¥æ•¸é‡");
                }
                const payload = {
                    time: new Date().toLocaleString('zh-TW', { hour12: false }),
                    user: form.value.user, code: form.value.code, name: form.value.name,
                    qty: qty, isUrgent: form.value.isUrgent, processed: false
                };
                await push(dbRef(db, "transfer_logs"), payload);
                form.value.qtyStr = ''; form.value.isUrgent = false; form.value.name = ''; searchQuery.value = '';
                alert("æäº¤æˆåŠŸ");
            };

            const openUrgentEdit = (log) => { editingUrgent.value = log; assistantQtyStr.value = ''; };

            const confirmUrgentEdit = async () => {
                calculate('assistant');
                const qty = Number(assistantQtyStr.value);
                if (!qty) return alert("è«‹è¼¸å…¥æ’¥è£œæ•¸");
                await update(dbRef(db, `transfer_logs/${editingUrgent.value.id}`), { qty: qty, processed: true });
                editingUrgent.value = null;
            };

            // æ¢å¾©åŒ¯å‡ºåŠŸèƒ½
            const exportByDate = async () => {
                const snapshot = await get(dbRef(db, "transfer_logs"));
                if (!snapshot.exists()) return alert("ç„¡è³‡æ–™");
                const d = new Date(filterDate.value);
                const targetDate = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
                
                const filtered = Object.values(snapshot.val()).filter(l => {
                    if (!l.time) return false;
                    const logDate = l.time.split(' ')[0].split('/').map(Number).join('/');
                    return logDate === targetDate;
                });

                if (filtered.length === 0) return alert("è©²æ—¥æœŸç„¡æ’¥è£œç´€éŒ„");

                const exportData = filtered.map(l => ({
                    'æ™‚é–“': l.time,
                    'äººå“¡': l.user,
                    'ä»£ç¢¼': l.code,
                    'åç¨±': l.name,
                    'æ•¸é‡': l.isUrgent ? (l.processed ? l.qty : 'æ€¥é ˜(æœªè™•ç†)') : l.qty,
                    'å‚™è¨»': l.isUrgent ? 'æ€¥é ˜ä»¶' : ''
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "æ’¥è£œç´€éŒ„");
                XLSX.writeFile(wb, `FYHæ’¥è£œå ±è¡¨_${filterDate.value}.xlsx`);
            };

            // UI è¼”åŠ©
            const onSearchInput = () => {
                const k = searchQuery.value.toLowerCase().trim();
                suggestions.value = k ? warehouse.value.filter(i => i.n?.toLowerCase().includes(k) || i.c?.toLowerCase().includes(k)).slice(0, 12) : [];
            };
            const selectDrug = (d) => {
                form.value.code = d.c; form.value.name = d.n; form.value.shelf = d.s || 'ç„¡';
                searchQuery.value = d.n; suggestions.value = [];
            };
            const clearSearch = () => { searchQuery.value = ''; suggestions.value = []; form.value.name = ''; };
            const deleteSingle = async (log) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await remove(dbRef(db, `transfer_logs/${log.id}`)); };
            const changeFontSize = (d) => { baseFontSize.value += d; document.documentElement.style.fontSize = `${baseFontSize.value}rem`; };
            const addStaff = () => { if(newStaffName.value) { staffList.value.push(newStaffName.value); set(dbRef(db, "staff_list"), staffList.value); newStaffName.value = ''; } };
            const removeStaff = (idx) => { staffList.value.splice(idx, 1); set(dbRef(db, "staff_list"), staffList.value); };

            return {
                form, searchQuery, suggestions, history, staffList, showManager, filterDate,
                editingUrgent, assistantQtyStr, openUrgentEdit, confirmUrgentEdit,
                onSearchInput, selectDrug, clearSearch, addNum, addOp, deleteLast, toggleSign,
                calculate, submitRecord, deleteSingle, addStaff, removeStaff, newStaffName,
                goBack: () => window.location.href = 'search.html', changeFontSize,
                pendingUrgent, filteredHistory, exportByDate
            };
        }
    }).mount('#app');
</script>
</body>
</html>
