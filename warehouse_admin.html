<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>藥庫儲位資料管理 (雲端同步版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f1f5f9; }
        .upload-area:hover { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="p-4 sm:p-8">

<div id="app" class="max-w-xl mx-auto bg-white shadow-2xl rounded-3xl p-6 sm:p-10 border border-slate-200">
    <header class="text-center mb-8">
        <div class="inline-block bg-amber-500 p-4 rounded-2xl shadow-lg mb-4">
            <i class="fa-solid fa-cloud-arrow-up text-white text-3xl"></i>
        </div>
        <h1 class="text-3xl font-black text-slate-800 tracking-tight">藥庫儲位維護</h1>
        <p class="text-slate-500 mt-2 font-bold">同步 Excel 資料至雲端資料庫</p>
    </header>

    <section class="bg-slate-50 rounded-2xl p-4 mb-8 border border-slate-100">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fa-solid fa-circle-info mr-1 text-blue-500"></i> Excel 格式要求</h3>
        <ul class="text-sm text-slate-500 space-y-1 ml-5 list-disc">
            <li>第一欄 (A)：藥品代碼</li>
            <li>第二欄 (B)：藥名</li>
            <li>第三欄 (C)：儲位編號</li>
        </ul>
    </section>

    <div v-if="!isProcessing" 
         @click="$refs.fileInput.click()"
         class="upload-area border-4 border-dashed border-slate-200 rounded-3xl p-12 text-center transition-all cursor-pointer">
        <input type="file" @change="handleFileUpload" accept=".xlsx, .xls" class="hidden" ref="fileInput">
        <i class="fa-solid fa-file-excel text-5xl text-slate-300 mb-4"></i>
        <p class="text-xl font-bold text-slate-700">點擊選擇檔案</p>
        <p class="text-xs text-slate-400 mt-2">上傳後將自動覆蓋舊有的雲端藥庫資料</p>
    </div>

    <div v-else class="py-12 text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-amber-500 border-t-transparent mb-4"></div>
        <p class="text-lg font-bold text-amber-600">正在處理並同步雲端...</p>
        <p class="text-xs text-slate-400 mt-2">請勿關閉或重新整理網頁</p>
    </div>

    <div v-if="count > 0 && !isProcessing" class="mt-8 p-4 bg-emerald-50 text-emerald-700 rounded-2xl font-bold text-center border border-emerald-100">
        <i class="fa-solid fa-check-circle mr-1"></i> 目前雲端資料庫已有 {{ count }} 筆資料
    </div>

    <div class="grid grid-cols-2 gap-4 mt-10">
        <button @click="clearWarehouse" class="bg-white border-2 border-red-100 text-red-500 font-bold py-3 rounded-2xl hover:bg-red-50 transition active:scale-95">
            <i class="fa-solid fa-trash-can mr-1"></i> 清空雲端
        </button>
        <a href="index.html" class="bg-slate-800 text-white font-bold py-3 rounded-2xl text-center hover:bg-slate-700 transition active:scale-95 flex items-center justify-center gap-2">
            <i class="fa-solid fa-house text-sm"></i> 回首頁
        </a>
    </div>
</div>

<script type="module">
    import { createApp, ref, onMounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase 配置 (與盤點系統相同)
    const firebaseConfig = {
      apiKey: "AIzaSyDZuNztwb9aLG1RqeDOyrj6KJrPhwBFi9M",
      authDomain: "fyh-pharmacy-inventory.firebaseapp.com",
      databaseURL: "https://fyh-pharmacy-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fyh-pharmacy-inventory",
      storageBucket: "fyh-pharmacy-inventory.firebasestorage.app",
      messagingSenderId: "751378148626",
      appId: "1:751378148626:web:5a2d2be1c5f905657457cb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const count = ref(0);
            const isProcessing = ref(false);

            onMounted(() => {
                // 安全檢查：簡單密碼保護
                const pass = prompt("請輸入管理員密碼");
                if (pass !== "8888") {
                    alert("密碼錯誤，將返回首頁");
                    window.location.href = "index.html";
                }

                // 獲取雲端目前數量
                onValue(dbRef(db, "warehouse"), s => {
                    const data = s.val();
                    if (data) count.value = Object.keys(data).length;
                    else count.value = 0;
                });
            });

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!confirm("確定要上傳並覆蓋現有的藥庫儲位資料嗎？")) return;

                isProcessing.value = true;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const sheetName = wb.SheetNames[0];
                        const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { header: 1 });
                        
                        // 優化：欄位壓縮處理以提升效能
                        // 第一欄 row[0]: 代碼 -> c
                        // 第二欄 row[1]: 藥名 -> n
                        // 第三欄 row[2]: 儲位 -> s
                        const parsed = rows.slice(1) // 跳過第一行標題
                            .filter(row => row[1])   // 過濾掉藥名為空的行
                            .map((row) => ({
                                c: String(row[0] || '').trim(), 
                                n: String(row[1] || '').trim(), 
                                s: String(row[2] || '').trim(),
                                z: '藥庫',
                                q: 999999 // 權重
                            }));

                        await set(dbRef(db, "warehouse"), parsed);
                        alert(`雲端同步完成！共匯入 ${parsed.length} 筆資料。`);
                    } catch (err) {
                        alert("處理發生錯誤：" + err.message);
                    } finally {
                        isProcessing.value = false;
                        e.target.value = ''; // 重置 file input
                    }
                };
                reader.readAsBinaryString(file);
            };

            const clearWarehouse = () => {
                if (confirm("警告：此操作將徹底清空雲端藥庫資料，且無法還原！確定執行？")) {
                    set(dbRef(db, "warehouse"), null);
                }
            };

            return { count, isProcessing, handleFileUpload, clearWarehouse };
        }
    }).mount('#app');
</script>
</body>
</html>
