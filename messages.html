<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è±åŸé†«é™¢è—¥åŠ‘ç§‘ - å³æ™‚é€šå ±ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <header class="bg-white p-6 rounded-2xl shadow-sm mb-6 flex justify-between items-center border border-slate-200">
            <h1 class="text-2xl font-black text-slate-800">ğŸ¥ è—¥åŠ‘ç§‘å³æ™‚çœ‹æ¿</h1>
            <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold">åŒ¯å‡º Excel</button>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <button onclick="sendPush('è«‹æ”¯æ´ç™¼è—¥', true)" class="h-20 bg-red-500 text-white rounded-xl shadow-md text-xl font-bold active:scale-95 transition">ğŸ’Š ç™¼è—¥</button>
            <button onclick="sendPush('è«‹æ”¯æ´ Check', true)" class="h-20 bg-emerald-500 text-white rounded-xl shadow-md text-xl font-bold active:scale-95 transition">âœ… Check</button>
            <button onclick="sendPush('è«‹æ”¯æ´ä¸­è—¥', true)" class="h-20 bg-orange-500 text-white rounded-xl shadow-md text-xl font-bold active:scale-95 transition">ğŸŒ¿ ä¸­è—¥</button>
            <button onclick="sendPush('è«‹æ”¯æ´èª¿åŠ‘', true)" class="h-20 bg-blue-500 text-white rounded-xl shadow-md text-xl font-bold active:scale-95 transition">ğŸ§ª èª¿åŠ‘</button>
        </div>

        <div id="msgList" class="space-y-3">
            <p class="text-center text-slate-400">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>
        </div>
    </div>

    <script>
        const SB_URL = 'https://zgfahzuocfmbssxckctj.supabase.co';
        const SB_KEY = 'sb_publishable_FX0MXRN8eY_oI_N3ypYn6A_uLrTsqo7';
        const _client = supabase.createClient(SB_URL, SB_KEY);

        let msgs = [];

        async function init() {
            // æŠ“å–è³‡æ–™æ¸¬è©¦
            const { data, error } = await _client.from('messages').select('*').order('created_at', { ascending: false }).limit(20);
            
            if (error) {
                document.getElementById('msgList').innerHTML = `<div class="bg-red-100 p-4 text-red-700 rounded-lg text-center font-bold">é€£ç·šå¤±æ•—ï¼š${error.message}<br>è«‹æª¢æŸ¥ Supabase æ˜¯å¦æœ‰ messages è¡¨æ ¼ä¸” RLS å·²é—œé–‰ã€‚</div>`;
                return;
            }

            msgs = data || [];
            render();

            // å³æ™‚ç›£è½
            _client.channel('public:messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
                msgs.unshift(p.new);
                render();
                if (p.new.voice) speak(p.new.text);
            })
            .subscribe();
        }

        async function sendPush(text, voice) {
            await _client.from('messages').insert([{ text, voice }]);
        }

        function render() {
            const list = document.getElementById('msgList');
            if (msgs.length === 0) {
                list.innerHTML = '<p class="text-center text-slate-400">ç›®å‰æ²’æœ‰è¨Šæ¯</p>';
                return;
            }
            list.innerHTML = msgs.map(m => `
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-8 ${m.voice ? 'border-blue-500' : 'border-slate-300'}">
                    <div class="text-lg font-bold">${m.text}</div>
                    <div class="text-xs text-slate-400">${new Date(m.created_at).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function speak(t) {
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'zh-TW';
            window.speechSynthesis.speak(u);
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(msgs.map(m => ({ "æ™‚é–“": new Date(m.created_at).toLocaleString(), "å…§å®¹": m.text })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç´€éŒ„");
            XLSX.writeFile(wb, "äº¤ç­ç´€éŒ„.xlsx");
        }

        document.body.addEventListener('click', () => {}, {once: true});
        init();
    </script>
</body>
</html>
