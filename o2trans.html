<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>é‹¼ç“¶ç®¡ç†ç³»çµ± - è—¥åŠ‘ç§‘</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; touch-action: manipulation; }
        .big-btn { transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
        .big-btn:active { transform: scale(0.95); opacity: 0.8; }
        
        /* ç›¸æ©Ÿå¤–æ¡†èˆ‡æƒæç·šå‹•ç•« */
        #reader { 
            border: 4px solid #4f46e5; 
            border-radius: 1rem; 
            overflow: hidden; 
            background: #000; 
            height: 250px !important; 
            position: relative;
        }
        #reader video { object-fit: cover !important; }
        
        /* æƒæç·šæ•ˆæœ */
        .scanning-active::after {
            content: "";
            position: absolute;
            top: 0;
            left: 5%;
            width: 90%;
            height: 2px;
            background: rgba(250, 204, 21, 0.8);
            box-shadow: 0 0 10px 2px #facc15;
            animation: scanMove 2s linear infinite;
            z-index: 10;
        }
        @keyframes scanMove {
            0% { top: 10%; }
            50% { top: 90%; }
            100% { top: 10%; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <header class="bg-indigo-700 text-white py-4 px-4 shadow-lg sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-xl font-black">é‹¼ç“¶ç®¡ç†ç³»çµ±</h1>
        <button onclick="location.reload()" class="bg-indigo-500 px-3 py-1 rounded-lg text-sm font-bold">é‡æ•´</button>
    </header>

    <main class="max-w-xl mx-auto p-3 space-y-4">
        
        <div class="bg-white rounded-2xl shadow p-4 border-b-4 border-indigo-100">
            <select id="unitSelect" class="w-full bg-indigo-50 border-2 border-indigo-200 p-3 rounded-xl text-xl font-bold text-gray-800 focus:outline-none">
                <option>è¼‰å…¥å–®ä½ä¸­...</option>
            </select>
        </div>

        <div class="bg-white rounded-2xl shadow p-4 border-b-4 border-indigo-100 text-center relative">
            
            <div id="reader" class="mb-4 mx-auto"></div>
            
            <div id="scanStatus" class="hidden mb-2 py-2 bg-yellow-400 text-black font-black rounded-full text-lg shadow">
                æ­£åœ¨æƒæï¼š<span id="currentModeLabel"></span>
            </div>

            <div id="listContainer" class="hidden mb-4 bg-slate-50 rounded-xl p-3 border-2 border-dashed border-indigo-300 text-left">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-black text-indigo-800">å¾…å‚³æ¸…å–®ï¼š(<span id="scanCount">0</span> ç“¶)</span>
                    <button onclick="if(confirm('ç¢ºå®šæ¸…ç©ºå—ï¼Ÿ')) location.reload()" class="text-xs text-rose-500 font-bold underline">æ¸…ç©º</button>
                </div>
                <ul id="scanList" class="space-y-2 max-h-48 overflow-y-auto"></ul>
            </div>

            <div class="flex flex-col gap-3">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="unlockAndStart('é ˜å‡º')" class="big-btn bg-emerald-600 text-white py-6 rounded-2xl shadow-lg flex flex-col items-center">
                        <span class="text-2xl font-black">é ˜å‡ºæ–°ç“¶</span>
                    </button>
                    <button onclick="unlockAndStart('é€€å›')" class="big-btn bg-rose-600 text-white py-6 rounded-2xl shadow-lg flex flex-col items-center">
                        <span class="text-2xl font-black">é€€å›ç©ºç“¶</span>
                    </button>
                </div>
                <button id="btn-stop" onclick="stopScanner()" class="hidden big-btn bg-gray-800 text-white py-4 rounded-2xl text-xl font-black">ğŸ›‘ åœæ­¢æƒæ</button>
                <button onclick="submitData()" id="submitBtn" class="hidden big-btn w-full bg-indigo-600 text-white py-6 rounded-2xl text-2xl font-black shadow-xl">ç¢ºèªä¸Šå‚³ (OK)</button>
            </div>
        </div>

        <div class="bg-slate-800 rounded-2xl p-4 text-white">
            <h2 class="text-sm font-bold text-yellow-300 mb-2 underline">å–®ä½ç›®å‰é ˜ç”¨æ•¸é‡</h2>
            <div id="dashboard" class="grid grid-cols-2 gap-x-4 gap-y-1 text-[11px]">è¼‰å…¥ä¸­...</div>
        </div>
    </main>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyrBucrvL8pQe06ogEsD3YajMc83VzLpdRK6pyPa5lzBXUvg3ghxoR6MXevYGgTH6gi-Q/exec";
        let scanResults = [];
        let currentMode = "";
        let isRunning = false;
        let lastResult = "";
        let lastTime = 0;
        const html5QrCode = new Html5Qrcode("reader");

        function speak(text) {
            if ('speechSynthesis' in window) {
                const synth = window.speechSynthesis;
                synth.cancel(); 
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'zh-TW'; msg.rate = 1.3;
                synth.speak(msg);
            }
        }

        function unlockAndStart(mode) { speak(""); toggleScan(mode); }

        async function getGAS(action) {
            const resp = await fetch(`${API_URL}?action=${action}`);
            return await resp.json();
        }

        window.onload = async () => {
            try {
                const units = await getGAS("getUnits");
                const select = document.getElementById('unitSelect');
                select.innerHTML = "";
                units.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u[0]; opt.textContent = u[1];
                    select.appendChild(opt);
                });
                refreshDashboard();
            } catch (e) { console.error("API è¼‰å…¥å¤±æ•—"); }
        };

        async function refreshDashboard() {
            try {
                const data = await getGAS("getDashboard");
                const div = document.getElementById('dashboard');
                div.innerHTML = data.map(item => `<div>${item.name}: <span class="text-yellow-400 font-bold">${item.count}</span></div>`).join('');
            } catch (e) {}
        }

        function toggleScan(mode) {
            if (isRunning) { html5QrCode.stop().then(() => runScanner(mode)); } 
            else { runScanner(mode); }
        }

        // --- ğŸš€ å¼·åŒ–ç‰ˆæƒæå•Ÿå‹•é‚è¼¯ ---
        function runScanner(mode) {
            currentMode = mode;
            isRunning = true;
            document.getElementById('scanStatus').classList.remove('hidden');
            document.getElementById('currentModeLabel').textContent = mode;
            document.getElementById('btn-stop').classList.remove('hidden');
            document.getElementById('submitBtn').classList.add('hidden');
            document.getElementById('reader').classList.add('scanning-active');

            html5QrCode.start(
                { facingMode: "environment" },
                { 
                    fps: 30, // æé«˜åµæ¸¬é »ç‡
                    qrbox: { width: 250, height: 250 }, // æ­£æ–¹å½¢åµæ¸¬å€æ›´æº–ç¢º
                    aspectRatio: 1.0,
                    videoConstraints: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: "environment"
                    }
                },
                (text) => {
                    const now = Date.now();
                    if (text === lastResult && (now - lastTime) < 2500) return;
                    lastResult = text; lastTime = now;
                    addToList(text);
                }
            ).then(() => {
                // ğŸ’¡ å˜—è©¦é–‹å•Ÿè‡ªå‹•ç¸®æ”¾ (Zoom) ä»¥æ‡‰å°å¾®å°æ¨™ç±¤
                const track = html5QrCode.getRunningTrack();
                const capabilities = track.getCapabilities();
                if (capabilities.zoom) {
                    track.applyConstraints({ advanced: [{ zoom: 2.0 }] }); // é è¨­è¼•å¾®æ”¾å¤§ 2 å€
                }
            }).catch(err => alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"));
        }

        function stopScanner() {
            if (!isRunning) return;
            html5QrCode.stop().then(() => {
                isRunning = false;
                document.getElementById('scanStatus').classList.add('hidden');
                document.getElementById('btn-stop').classList.add('hidden');
                document.getElementById('reader').classList.remove('scanning-active');
                if (scanResults.length > 0) document.getElementById('submitBtn').classList.remove('hidden');
            });
        }

        function addToList(sn) {
            const unitCode = document.getElementById('unitSelect').value;
            if (scanResults.some(r => r.sn === sn && r.type === currentMode)) return;
            scanResults.push({ unitCode, type: currentMode, sn });
            speak(`ç¬¬${scanResults.length}ç“¶`);
            if (navigator.vibrate) navigator.vibrate(80);
            renderListUI();
        }

        function renderListUI() {
            const container = document.getElementById('listContainer');
            const list = document.getElementById('scanList');
            if (scanResults.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            document.getElementById('scanCount').textContent = scanResults.length;
            list.innerHTML = "";
            [...scanResults].reverse().forEach((item, index) => {
                const realIndex = scanResults.length - 1 - index;
                const li = document.createElement('li');
                li.className = `p-3 rounded-xl flex justify-between items-center text-sm font-bold border mb-2 ${item.type === 'é€€å›' ? 'bg-rose-50 border-rose-200 text-rose-700' : 'bg-emerald-50 border-emerald-200 text-emerald-700'}`;
                li.innerHTML = `<span>${item.type} | ${item.sn}</span><button onclick="removeItem(${realIndex})" class="bg-rose-500 text-white w-7 h-7 rounded-full flex items-center justify-center">âœ•</button>`;
                list.appendChild(li);
            });
        }

        function removeItem(index) {
            if (confirm("åˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ")) { scanResults.splice(index, 1); renderListUI(); }
        }

        async function submitData() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = "æ­£åœ¨ä¸Šå‚³ç´€éŒ„...";
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "saveRecords", data: scanResults })
            });
            alert("ğŸ‘Œ ç™»è¨˜æˆåŠŸï¼");
            location.reload();
        }
    </script>
</body>
</html>
