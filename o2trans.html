<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>æ°§æ°£é‹¼ç“¶æ´¾é£ç³»çµ± - è—¥åŠ‘ç§‘</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; touch-action: manipulation; }
        .big-btn { transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
        .big-btn:active { transform: scale(0.95); opacity: 0.8; }
        #reader { border: 6px solid #4f46e5; border-radius: 1.5rem; overflow: hidden; background: #000; }
        .scanning-active { outline: 10px solid #facc15; outline-offset: -10px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <header class="bg-indigo-700 text-white py-6 px-4 shadow-xl sticky top-0 z-50 flex justify-between items-center">
        <div class="flex flex-col">
            <h1 class="text-2xl font-black">é‹¼ç“¶ç®¡ç†ç³»çµ±</h1>
            <span class="text-xs opacity-80">ğŸ”Š æƒææˆåŠŸæœƒèªéŸ³å ±æ•¸</span>
        </div>
        <button onclick="location.reload()" class="bg-indigo-500 px-4 py-2 rounded-xl text-sm font-bold">é‡æ•´</button>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-6">
        <div class="bg-white rounded-3xl shadow-md p-6 border-b-8 border-indigo-100">
            <label class="block text-xl font-black text-indigo-900 mb-3">1. é¸æ“‡å–®ä½ï¼š</label>
            <select id="unitSelect" class="w-full bg-indigo-50 border-4 border-indigo-200 p-5 rounded-2xl text-2xl font-bold text-gray-800 focus:outline-none">
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>

        <div class="bg-white rounded-3xl shadow-md p-6 border-b-8 border-indigo-100 text-center">
            <div id="reader" class="mb-6 mx-auto"></div>
            
            <div id="scanStatus" class="hidden mb-4 py-3 bg-yellow-400 text-black font-black rounded-full text-xl shadow-lg">
                æ­£åœ¨é€£çºŒæƒæï¼š<span id="currentModeLabel"></span>
            </div>

            <div class="flex flex-col gap-4">
                <button onclick="toggleScan('é ˜å‡º')" class="big-btn bg-emerald-600 text-white py-10 rounded-3xl shadow-xl flex flex-col items-center">
                    <span class="text-4xl font-black">âŠ• é ˜å‡ºæ–°ç“¶</span>
                </button>
                <button onclick="toggleScan('é€€å›')" class="big-btn bg-rose-600 text-white py-10 rounded-3xl shadow-xl flex flex-col items-center">
                    <span class="text-4xl font-black">âŠ– é€€å›ç©ºç“¶</span>
                </button>
                <button id="btn-stop" onclick="stopScanner()" class="hidden big-btn bg-gray-800 text-white py-6 rounded-3xl text-2xl font-black">ğŸ›‘ åœæ­¢æƒæ</button>
            </div>
        </div>

        <div id="listContainer" class="hidden bg-white rounded-3xl shadow-2xl p-6 border-4 border-indigo-500">
            <h3 class="text-2xl font-black text-gray-800 mb-4 text-center">å¾…å­˜æ¸…å–® (<span id="scanCount">0</span>)</h3>
            <ul id="scanList" class="space-y-2 mb-6 max-h-60 overflow-y-auto"></ul>
            <button onclick="submitData()" id="submitBtn" class="big-btn w-full bg-indigo-600 text-white py-8 rounded-2xl text-3xl font-black">ç¢ºèªä¸Šå‚³</button>
        </div>
    </main>

    <script>
        // ğŸš€ API URL (èˆ‡ä¹‹å‰ç›¸åŒ)
        const API_URL = "https://script.google.com/macros/s/AKfycbyrBucrvL8pQe06ogEsD3YajMc83VzLpdRK6pyPa5lzBXUvg3ghxoR6MXevYGgTH6gi-Q/exec";

        let scanResults = [];
        let currentMode = "";
        let isRunning = false;
        let lastResult = "";
        let lastTime = 0;
        const html5QrCode = new Html5Qrcode("reader");

        // --- ğŸ—£ï¸ èªéŸ³å ±æ•¸å‡½å¼ ---
        function speakCount(count) {
            if ('speechSynthesis' in window) {
                // å…ˆå–æ¶ˆæ‰€æœ‰æ­£åœ¨æ’éšŠçš„èªéŸ³ï¼Œé¿å…å»¶é²
                window.speechSynthesis.cancel();
                
                const synth = window.speechSynthesis;
                const msg = new SpeechSynthesisUtterance(`ç¬¬${count}ç“¶`);
                msg.lang = 'zh-TW'; // è¨­å®šå°ç£ä¸­æ–‡
                msg.rate = 1.3;     // èªé€ŸåŠ å¿«ä¸€é»ï¼Œæƒææ‰æµæš¢
                msg.pitch = 1;      // éŸ³èª¿æ­£å¸¸
                synth.speak(msg);
            }
        }

        // --- ğŸ”ˆ å‚™ç”¨çš„å—¶è² (ç•¶èªéŸ³æ²’å‡ºä¾†æ™‚é‚„æœ‰è²éŸ³) ---
        function playBeep() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        // --- API é€£å‹• (POST) ---
        async function fetchGAS(action, data = null) {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action, data })
            });
            return true; 
        }

        // --- API é€£å‹• (GET) ---
        async function getGAS(action) {
            const resp = await fetch(`${API_URL}?action=${action}`);
            return await resp.json();
        }

        window.onload = async () => {
            try {
                const units = await getGAS("getUnits");
                const select = document.getElementById('unitSelect');
                select.innerHTML = "";
                units.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u[0]; opt.textContent = u[1];
                    select.appendChild(opt);
                });
            } catch (e) { console.error("API è¼‰å…¥å¤±æ•—"); }
        };

        function toggleScan(mode) {
            if (isRunning) { html5QrCode.stop().then(() => runScanner(mode)); } 
            else { runScanner(mode); }
        }

        function runScanner(mode) {
            currentMode = mode;
            isRunning = true;
            document.getElementById('scanStatus').classList.remove('hidden');
            document.getElementById('currentModeLabel').textContent = mode;
            document.getElementById('btn-stop').classList.remove('hidden');
            document.getElementById('reader').classList.add('scanning-active');

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 20, qrbox: { width: 300, height: 200 } },
                (text) => {
                    const now = Date.now();
                    // é˜²æ­¢é‡è¤‡æƒæåŒä¸€å€‹ code çš„é–“éš” (2.5ç§’)
                    if (text === lastResult && (now - lastTime) < 2500) return;
                    
                    lastResult = text;
                    lastTime = now;

                    addToList(text);
                }
            ).catch(err => alert("ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—"));
        }

        function stopScanner() {
            if (!isRunning) return;
            html5QrCode.stop().then(() => {
                isRunning = false;
                document.getElementById('scanStatus').classList.add('hidden');
                document.getElementById('btn-stop').classList.add('hidden');
                document.getElementById('reader').classList.remove('scanning-active');
            });
        }

        function addToList(sn) {
            const unitCode = document.getElementById('unitSelect').value;
            
            // æœ¬æ¬¡æƒæå¦‚æœå·²ç¶“åœ¨æ¸…å–®å…§å°±ä¸ç†å®ƒ
            if (scanResults.some(r => r.sn === sn && r.type === currentMode)) return;

            scanResults.push({ unitCode, type: currentMode, sn });
            
            // ğŸ“£ å ±æ•¸ï¼
            speakCount(scanResults.length);
            playBeep(); // å ±æ•¸çš„åŒæ™‚ä¹Ÿå—¶ä¸€è²ï¼Œè½æ„Ÿæ›´ç´®å¯¦
            if (navigator.vibrate) navigator.vibrate(100);

            document.getElementById('listContainer').classList.remove('hidden');
            document.getElementById('scanCount').textContent = scanResults.length;
            const list = document.getElementById('scanList');
            const li = document.createElement('li');
            li.className = `p-4 rounded-2xl flex justify-between items-center border-2 bg-white ${currentMode === 'é€€å›' ? 'border-rose-400' : 'border-emerald-400'}`;
            li.innerHTML = `<span class="font-black text-2xl">${currentMode}</span><span class="font-mono font-bold">${sn}</span>`;
            list.prepend(li);
        }

        async function submitData() {
            stopScanner();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = "å‚³é€ä¸­...";
            await fetchGAS("saveRecords", scanResults);
            alert("ğŸ‘Œ ç™»è¨˜æˆåŠŸï¼");
            location.reload();
        }
    </script>
</body>
</html>
