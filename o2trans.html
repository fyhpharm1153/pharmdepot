<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>é‹¼ç“¶ç®¡ç†ç³»çµ± - è—¥åŠ‘ç§‘</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; touch-action: manipulation; }
        .big-btn { transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
        .big-btn:active { transform: scale(0.95); opacity: 0.8; }
        /* ç›¸æ©Ÿé«˜åº¦å„ªåŒ– */
        #reader { border: 4px solid #4f46e5; border-radius: 1rem; overflow: hidden; background: #000; height: 250px !important; }
        #reader video { object-fit: cover !important; }
        .scanning-active { outline: 8px solid #facc15; outline-offset: -8px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <header class="bg-indigo-700 text-white py-4 px-4 shadow-lg sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-xl font-black">é‹¼ç“¶ç®¡ç†ç³»çµ±</h1>
        <button onclick="location.reload()" class="bg-indigo-500 px-3 py-1 rounded-lg text-sm">é‡æ•´</button>
    </header>

    <main class="max-w-xl mx-auto p-3 space-y-4">
        
        <div class="bg-white rounded-2xl shadow p-4 border-b-4 border-indigo-100">
            <select id="unitSelect" class="w-full bg-indigo-50 border-2 border-indigo-200 p-3 rounded-xl text-xl font-bold text-gray-800">
                <option>è¼‰å…¥å–®ä½ä¸­...</option>
            </select>
        </div>

        <div class="bg-white rounded-2xl shadow p-4 border-b-4 border-indigo-100 text-center">
            
            <div id="reader" class="mb-4 mx-auto"></div>
            
            <div id="scanStatus" class="hidden mb-2 py-2 bg-yellow-400 text-black font-black rounded-full text-lg shadow">
                æ­£åœ¨æƒæï¼š<span id="currentModeLabel"></span>
            </div>

            <div id="listContainer" class="hidden mb-4 bg-slate-50 rounded-xl p-3 border-2 border-dashed border-indigo-300">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-black text-indigo-800 text-lg">å¾…å‚³æ¸…å–®ï¼š(<span id="scanCount">0</span> ç“¶)</span>
                    <button onclick="if(confirm('ç¢ºå®šæ¸…ç©ºå—ï¼Ÿ')) location.reload()" class="text-xs text-rose-500 font-bold underline">æ¸…ç©ºé‡ä¾†</button>
                </div>
                <ul id="scanList" class="space-y-2 max-h-48 overflow-y-auto text-left">
                    </ul>
            </div>

            <div class="flex flex-col gap-3">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="unlockAndStart('é ˜å‡º')" class="big-btn bg-emerald-600 text-white py-6 rounded-2xl shadow-lg flex flex-col items-center">
                        <span class="text-2xl font-black">é ˜å‡ºæ–°ç“¶</span>
                    </button>
                    <button onclick="unlockAndStart('é€€å›')" class="big-btn bg-rose-600 text-white py-6 rounded-2xl shadow-lg flex flex-col items-center">
                        <span class="text-2xl font-black">é€€å›ç©ºç“¶</span>
                    </button>
                </div>
                <button id="btn-stop" onclick="stopScanner()" class="hidden big-btn bg-gray-800 text-white py-4 rounded-2xl text-xl font-black">ğŸ›‘ åœæ­¢æƒæ</button>
                <button onclick="submitData()" id="submitBtn" class="hidden big-btn w-full bg-indigo-600 text-white py-6 rounded-2xl text-2xl font-black shadow-xl">ç¢ºèªä¸Šå‚³ (OK)</button>
            </div>
        </div>

        <div class="bg-slate-800 rounded-2xl p-4 text-white">
            <h2 class="text-sm font-bold text-yellow-300 mb-2">ç›®å‰å–®ä½é ˜ç”¨çµ±è¨ˆ</h2>
            <div id="dashboard" class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">è¼‰å…¥ä¸­...</div>
        </div>
    </main>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyrBucrvL8pQe06ogEsD3YajMc83VzLpdRK6pyPa5lzBXUvg3ghxoR6MXevYGgTH6gi-Q/exec";
        let scanResults = [];
        let currentMode = "";
        let isRunning = false;
        let lastResult = "";
        let lastTime = 0;
        const html5QrCode = new Html5Qrcode("reader");

        // --- ğŸ—£ï¸ èªéŸ³å ±æ•¸ ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                const synth = window.speechSynthesis;
                synth.cancel(); 
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'zh-TW';
                msg.rate = 1.3;
                synth.speak(msg);
            }
        }

        function unlockAndStart(mode) {
            speak(""); // é»æ“Šæ™‚å¼·åˆ¶è§£é–èªéŸ³
            toggleScan(mode);
        }

        async function getGAS(action) {
            const resp = await fetch(`${API_URL}?action=${action}`);
            return await resp.json();
        }

        window.onload = async () => {
            try {
                const units = await getGAS("getUnits");
                const select = document.getElementById('unitSelect');
                select.innerHTML = "";
                units.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u[0]; opt.textContent = u[1];
                    select.appendChild(opt);
                });
                refreshDashboard();
            } catch (e) { console.error("API è¼‰å…¥å¤±æ•—"); }
        };

        async function refreshDashboard() {
            try {
                const data = await getGAS("getDashboard");
                const div = document.getElementById('dashboard');
                div.innerHTML = data.map(item => `<div>${item.name}: <span class="text-yellow-400 font-bold">${item.count}</span></div>`).join('');
            } catch (e) {}
        }

        function toggleScan(mode) {
            if (isRunning) { html5QrCode.stop().then(() => runScanner(mode)); } 
            else { runScanner(mode); }
        }

        function runScanner(mode) {
            currentMode = mode;
            isRunning = true;
            document.getElementById('scanStatus').classList.remove('hidden');
            document.getElementById('currentModeLabel').textContent = mode;
            document.getElementById('btn-stop').classList.remove('hidden');
            document.getElementById('submitBtn').classList.add('hidden');

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 20, qrbox: { width: 250, height: 150 } },
                (text) => {
                    const now = Date.now();
                    if (text === lastResult && (now - lastTime) < 2500) return;
                    lastResult = text; lastTime = now;
                    addToList(text);
                }
            ).catch(err => alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"));
        }

        function stopScanner() {
            if (!isRunning) return;
            html5QrCode.stop().then(() => {
                isRunning = false;
                document.getElementById('scanStatus').classList.add('hidden');
                document.getElementById('btn-stop').classList.add('hidden');
                if (scanResults.length > 0) document.getElementById('submitBtn').classList.remove('hidden');
            });
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šåŠ å…¥æ¸…å–®ä¸¦æ¸²æŸ“ ---
        function addToList(sn) {
            const unitCode = document.getElementById('unitSelect').value;
            // é˜²é‡è¤‡
            if (scanResults.some(r => r.sn === sn && r.type === currentMode)) return;

            // åŠ å…¥é™£åˆ—
            scanResults.push({ unitCode, type: currentMode, sn });
            
            // èªéŸ³å ±æ•¸ (ç¬¬Xç“¶)
            speak(`ç¬¬${scanResults.length}ç“¶`);
            if (navigator.vibrate) navigator.vibrate(80);

            renderListUI();
        }

        // --- æ¸²æŸ“æ¸…å–®ä»‹é¢ (å«åˆªé™¤æŒ‰éˆ•) ---
        function renderListUI() {
            const container = document.getElementById('listContainer');
            const list = document.getElementById('scanList');
            const countSpan = document.getElementById('scanCount');

            if (scanResults.length === 0) {
                container.classList.add('hidden');
                document.getElementById('submitBtn').classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            countSpan.textContent = scanResults.length;
            list.innerHTML = "";

            // å€’åºé¡¯ç¤º (æœ€æ–°æƒåˆ°çš„åœ¨æœ€ä¸Šé¢)
            [...scanResults].reverse().forEach((item, index) => {
                // è¨ˆç®—åœ¨åŸé™£åˆ—ä¸­çš„çœŸå¯¦ index
                const realIndex = scanResults.length - 1 - index;
                
                const li = document.createElement('li');
                li.className = `p-3 rounded-xl flex justify-between items-center text-base font-bold border shadow-sm ${item.type === 'é€€å›' ? 'bg-rose-50 border-rose-200 text-rose-700' : 'bg-emerald-50 border-emerald-200 text-emerald-700'}`;
                li.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="bg-white px-1 rounded border border-current text-xs">${item.type}</span>
                        <span class="font-mono text-gray-800">${item.sn}</span>
                    </div>
                    <button onclick="removeItem(${realIndex})" class="bg-rose-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-black shadow active:bg-rose-700">âœ•</button>
                `;
                list.appendChild(li);
            });
        }

        // --- åŸ·è¡Œåˆªé™¤å–®ç­† ---
        function removeItem(index) {
            if (confirm("è¦åˆªé™¤é€™ä¸€ç“¶çš„ç´€éŒ„å—ï¼Ÿ")) {
                scanResults.splice(index, 1);
                renderListUI();
                // åˆªé™¤å¾Œä¸å ±æ•¸ï¼Œé¿å…æ··æ·†
            }
        }

        async function submitData() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = "ä¸Šå‚³ä¸­...";
            // ç”±æ–¼ GAS POST no-cors é™åˆ¶ï¼Œæˆ‘å€‘ä¸ç­‰å¾… JSON å›å‚³ï¼Œç›´æ¥è¦–ç‚ºæˆåŠŸ
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "saveRecords", data: scanResults })
            });
            alert("ğŸ‘Œ ç™»è¨˜å®Œæˆï¼Œå…± " + scanResults.length + " ç“¶ï¼");
            location.reload();
        }
    </script>
</body>
</html>
