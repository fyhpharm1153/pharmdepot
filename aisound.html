<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥è¢‹åŠ©æ‰‹ - è±åŸé†«é™¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --med-teal: #00796b; }
        body { background-color: #f4f7f6; font-family: "PingFang TC", sans-serif; }
        .app-header { background: var(--med-teal); color: white; padding: 12px; text-align: center; }
        
        /* å›æ­¸ä¸Šä¸Šç‰ˆæœ¬çš„å°å‹æ¸…æ¥šæƒææ¡† */
        #scanner-container {
            width: 280px; height: 280px;
            margin: 20px auto;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: #000;
        }
        #reader { width: 100%; height: 100%; }

        .lang-section { padding: 0 15px; }
        .result-card {
            background: white; border-radius: 20px; padding: 25px; margin: 15px;
            display: none; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .info-row { border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
        .label { color: #888; font-size: 0.85rem; }
        .value { color: #333; font-weight: bold; font-size: 1.2rem; }
        
        .btn-calendar {
            background-color: #1a73e8; color: white; border: none;
            width: 100%; padding: 14px; border-radius: 12px; font-weight: bold; margin-top: 15px;
        }
        #start-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; }
    </style>
</head>
<body>

<div class="app-header"><h6>è—¥è¢‹è‡ªå‹•æƒæè¼”åŠ©ç³»çµ±</h6></div>

<div class="lang-section mt-3">
    <select id="langSelect" class="form-select form-select-lg">
        <option value="zh-TW">ä¸­æ–‡ (åœ‹èª)</option>
        <option value="nan-TW" selected>å°èª (æ“¬çœŸæ‹¼éŸ³)</option>
        <option value="fil-PH">Filipino (è²å¾‹è³“æ–‡)</option>
        <option value="vi-VN">Tiáº¿ng Viá»‡t (è¶Šå—æ–‡)</option>
        <option value="id-ID">Bahasa Indonesia (å°å°¼æ–‡)</option>
        <option value="th-TH">à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ (æ³°æ–‡)</option>
        <option value="en-US">English (è‹±æ–‡)</option>
    </select>
</div>

<div id="scanner-container">
    <div id="reader"></div>
    <button id="start-btn" class="btn btn-primary" onclick="startScanner()">é–‹å•Ÿç›¸æ©Ÿ</button>
</div>

<div id="resultCard" class="result-card">
    <div class="info-row">
        <div class="label">æœç”¨é€”å¾‘</div>
        <div id="res-route" class="value">-</div>
    </div>
    <div class="info-row">
        <div class="label">æœç”¨æ™‚é–“</div>
        <div id="res-freq" class="value">-</div>
    </div>
    
    <button class="btn btn-light w-100 mt-3" onclick="replayAudio()">ğŸ”Š é‡æ–°æ’­æ”¾èªéŸ³</button>
    <button id="calBtn" class="btn-calendar">ğŸ“… åŠ å…¥æ‰‹æ©Ÿè¡Œäº‹æ›†æé†’</button>
</div>

<script>
    const translations = {
        'zh-TW': { engine: 'zh', welcome: 'æ‚¨å¥½ï¼Œé€™å€‹è—¥', use: 'æ–¹å¼æ˜¯', 'QDPC': { d: 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨', s: 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨' }, 'PO': { d: 'å£æœ', s: 'å£æœ' }, 'EXT': { d: 'å¤–ç”¨', s: 'å¤–ç”¨' } },
        'nan-TW': { engine: 'en', welcome: 'Li-ho, Jiy-kuan yo-ah', use: 'chi-ah h-ah shi', 'QDPC': { d: 'é€å·¥ä¸€æ”¹ï¼Œé£Ÿé£½æ‰é£Ÿ', s: 'Tak-kang chit-kai, chiah-pah chiah chiah' }, 'PO': { d: 'ç”¨é£Ÿçš„', s: 'yong chiah eh' }, 'EXT': { d: 'å¤–ç”¨çš„', s: 'guah-yong eh' } },
        'fil-PH': { engine: 'fil', welcome: 'Hello, ang gamot na ito', use: 'ang paraan ay', 'QDPC': { d: 'Minsan sa isang araw pagkatapos kumain', s: 'Minsan sa isang araw pagkatapos kumain' }, 'PO': { d: 'Iniinom', s: 'Iniinom' }, 'EXT': { d: 'Pang-labas', s: 'Pang-labas' } },
        'vi-VN': { engine: 'vi', welcome: 'Xin chÃ o, thuá»‘c nÃ y', use: 'cÃ¡ch dÃ¹ng lÃ ', 'QDPC': { d: 'Má»—i ngÃ y má»™t láº§n sau khi Äƒn', s: 'Má»—i ngÃ y má»™t láº§n sau khi Äƒn' }, 'PO': { d: 'ÄÆ°á»ng uá»‘ng', s: 'ÄÆ°á»ng uá»‘ng' } },
        'id-ID': { engine: 'id', welcome: 'Halo, obat ini', use: 'cara pakainya', 'QDPC': { d: 'Sekali sehari setelah makan', s: 'Sekali sehari setelah makan' }, 'PO': { d: 'Diminum', s: 'Diminum' } },
        'th-TH': { engine: 'th', welcome: 'à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸° à¸¢à¸²à¸•à¸±à¸§à¸™à¸µà¹‰', use: 'à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¸„à¸·à¸­', 'QDPC': { d: 'à¸§à¸±à¸™à¸¥à¸°à¸«à¸™à¸¶à¹ˆà¸‡à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£', s: 'à¸§à¸±à¸™à¸¥à¸°à¸«à¸™à¸¶à¹ˆà¸‡à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£' }, 'PO': { d: 'à¸£à¸±à¸šà¸›à¸£à¸°à¸—à¸²à¸™', s: 'à¸£à¸±à¸šà¸›à¸£à¸°à¸—à¸²à¸™' } },
        'en-US': { engine: 'en', welcome: 'Hello, this medicine', use: 'way to use is', 'QDPC': { d: 'Once daily after meals', s: 'Once daily after meals' }, 'PO': { d: 'Oral', s: 'Oral' } }
    };

    let html5QrCode;
    let lastText = "";
    let currentMedicine = {};

    function startScanner() {
        document.getElementById('start-btn').style.display = 'none';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, onScanSuccess);
        window.speechSynthesis.getVoices();
    }

    function onScanSuccess(decodedText) {
        if (decodedText === lastText) return;
        const parts = decodedText.split(';');
        
        if (parts.length >= 7) {
            lastText = decodedText;
            const langKey = document.getElementById('langSelect').value;
            const dict = translations[langKey] || translations['zh-TW'];

            // è³‡æ–™è§£æ
            const startDate = parts[1]; // yyyymmdd (é ˜è—¥æ—¥æœŸ)
            const freqCode = parts[4];
            const routeCode = parts[5];
            const durationDays = parts[6]; // å¤©æ•¸

            const freq = dict[freqCode] || { d: freqCode, s: freqCode };
            const route = dict[routeCode] || { d: routeCode, s: routeCode };

            // æ›´æ–° UI
            document.getElementById('res-freq').innerText = freq.d;
            document.getElementById('res-route').innerText = route.d;
            document.getElementById('resultCard').style.display = 'block';

            // å„²å­˜è³‡è¨Šä¾›è¡Œäº‹æ›†ä½¿ç”¨
            currentMedicine = { 
                startDate, 
                days: durationDays, 
                title: `æœç”¨è—¥ç‰©æé†’ (${freq.d})`,
                notes: `è«‹éµç…§é†«å›‘ï¼š${route.d}ã€‚é è¨ˆæœç”¨ ${durationDays} å¤©ã€‚`
            };

            document.getElementById('calBtn').onclick = () => downloadIcs(currentMedicine);

            // èªéŸ³æ’­æ”¾
            speak(`${dict.welcome}, ${freq.s}, ${dict.use}, ${route.s}`, dict.engine);
            setTimeout(() => { lastText = ""; }, 5000);
        }
    }

    // è‡ªå‹•ç”¢ç”Ÿä¸¦ä¸‹è¼‰ .ics æª”æ¡ˆ (æ‰‹æ©Ÿæœƒè‡ªå‹•è­˜åˆ¥ä¸¦é–‹å•Ÿè¡Œäº‹æ›†)
    function downloadIcs(data) {
        const year = data.startDate.substring(0, 4);
        const month = data.startDate.substring(4, 6);
        const day = data.startDate.substring(6, 8);
        
        const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + "Z";
        const start = `${year}${month}${day}T090000`; // é è¨­æ—©ä¸Š 9 é»
        const end = `${year}${month}${day}T093000`;
        
        const icsContent = [
            "BEGIN:VCALENDAR",
            "VERSION:2.0",
            "PRODID:-//Feng Yuan Hospital//Pharmacy System//TW",
            "BEGIN:VEVENT",
            `DTSTAMP:${timestamp}`,
            `DTSTART;VALUE=DATE-TIME:${start}`,
            `DTEND;VALUE=DATE-TIME:${end}`,
            `SUMMARY:${data.title}`,
            `DESCRIPTION:${data.notes}`,
            `RRULE:FREQ=DAILY;COUNT=${data.days}`, // ä¾ç…§å¤©æ•¸é‡è¤‡
            "BEGIN:VALARM",
            "TRIGGER:-PT15M", // æå‰ 15 åˆ†é˜æé†’
            "ACTION:DISPLAY",
            "DESCRIPTION:Reminder",
            "END:VALARM",
            "END:VEVENT",
            "END:VCALENDAR"
        ].join("\r\n");

        const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "med_reminder.ics"; // æª”å
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function speak(text, engineKey) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const targetVoice = voices.find(v => v.lang.toLowerCase().startsWith(engineKey.toLowerCase()));
        
        if (targetVoice) utterance.voice = targetVoice;
        utterance.lang = (engineKey === 'en') ? 'en-US' : (engineKey === 'zh' ? 'zh-TW' : (engineKey === 'fil' ? 'fil-PH' : engineKey));
        utterance.rate = (engineKey === 'en') ? 0.75 : 0.85;
        window.speechSynthesis.speak(utterance);
    }

    function replayAudio() {
        if (lastText) onScanSuccess(lastText);
    }

    window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); };
</script>
</body>
</html>
