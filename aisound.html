<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥è¢‹èªéŸ³åŠ©æ‰‹ - è±åŸé†«é™¢ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --med-teal: #00796b; --med-dark: #004d40; }
        body { background-color: #f8faf9; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        .app-header { background: var(--med-teal); color: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        #scanner-wrapper {
            position: relative;
            width: 100%;
            max-width: 450px;
            aspect-ratio: 1 / 1;
            margin: 20px auto;
            border: 4px solid white;
            border-radius: 24px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        #reader { width: 100%; height: 100%; }

        #start-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            padding: 15px 35px;
            font-size: 1.25rem;
            font-weight: bold;
            border-radius: 50px;
            background-color: var(--med-teal);
            border: none;
        }

        .result-card {
            background: white;
            border-radius: 24px;
            padding: 25px;
            margin: -40px 15px 20px;
            position: relative;
            z-index: 20;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .label { color: #757575; font-size: 0.95rem; margin-bottom: 4px; }
        .value { color: var(--med-dark); font-weight: 800; font-size: 1.4rem; }
        .divider { height: 1px; background: #eee; margin: 15px 0; }
    </style>
</head>
<body>

<div class="app-header text-center">
    <h4 class="mb-0">è—¥è¢‹è‡ªå‹•æƒæèªéŸ³ç³»çµ±</h4>
</div>

<div class="container-fluid">
    <div id="scanner-wrapper">
        <div id="reader"></div>
        <button id="start-btn" class="btn btn-primary shadow-lg" onclick="startScanner()">é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
    </div>

    <div id="resultCard" class="result-card">
        <div class="text-center mb-3">
            <span class="badge rounded-pill bg-success px-4 py-2">æƒææˆåŠŸ</span>
        </div>
        <div class="row text-center">
            <div class="col-6">
                <div class="label">æ¯æ¬¡åŠ‘é‡</div>
                <div id="res-qty" class="value">-</div>
            </div>
            <div class="col-6">
                <div class="label">æœç”¨é€”å¾‘</div>
                <div id="res-route" class="value">-</div>
            </div>
            <div class="col-12 mt-3">
                <div class="divider"></div>
                <div class="label">æœç”¨æ™‚é–“èˆ‡é »æ¬¡</div>
                <div id="res-freq" class="value">-</div>
            </div>
        </div>
        <button class="btn btn-outline-dark w-100 mt-4 py-2 fw-bold" onclick="replayAudio()">ğŸ”Š é‡æ–°æ’­æ”¾èªéŸ³</button>
    </div>
</div>

<script>
    // 1. å¸¸ç”¨é€”å¾‘å°ç…§è¡¨ (ç¢ºä¿ç„¡è‹±æ–‡)
    const routeMap = {
        'PO': 'å£æœ',
        'EXT': 'å¤–ç”¨',
        'SL': 'èˆŒä¸‹å«æœ',
        'EYE': 'é»çœ¼',
        'EAR': 'é»è€³',
        'NAS': 'é»é¼»',
        'TOP': 'å±€éƒ¨å¡—æŠ¹',
        'SC': 'çš®ä¸‹æ³¨å°„',
        'IV': 'éœè„ˆæ³¨å°„',
        'IM': 'è‚Œè‚‰æ³¨å°„',
        'RECT': 'å¡å…¥è‚›é–€',
        'VAG': 'å¡å…¥é™°é“',
        'INH': 'å¸å…¥',
        'OTH': 'ä¾é†«å›‘ä½¿ç”¨'
    };

    // 2. å¸¸ç”¨é »æ¬¡å°ç…§è¡¨
    const sigMap = {
        'QD': 'æ¯æ—¥ä¸€æ¬¡',
        'QDPC': 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨',
        'QDAC': 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å‰æœç”¨',
        'BID': 'æ¯æ—¥äºŒæ¬¡',
        'TID': 'æ¯æ—¥ä¸‰æ¬¡',
        'QID': 'æ¯æ—¥å››æ¬¡',
        'HS': 'ç¡å‰æœç”¨',
        'QN': 'æ¯æ™šä¸€æ¬¡',
        'QOD': 'æ¯éš”ä¸€å¤©ä¸€æ¬¡',
        'PRN': 'éœ€è¦æ™‚æœç”¨',
        'STAT': 'ç«‹å³æœç”¨'
    };
    
    let html5QrCode;
    let lastText = "";
    let speechMessage = "";

    function startScanner() {
        document.getElementById('start-btn').style.display = 'none';
        html5QrCode = new Html5Qrcode("reader");
        
        const config = { 
            fps: 20, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };

        // å¼·åˆ¶ä½¿ç”¨å¾Œç½®é¡é ­
        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess
        ).catch(err => {
            alert("è«‹ç¢ºèªå·²é–‹å•Ÿç›¸æ©Ÿæ¬Šé™");
            document.getElementById('start-btn').style.display = 'block';
        });

        // é ç†±èªéŸ³å¼•æ“
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
    }

    function onScanSuccess(decodedText) {
        if (decodedText === lastText) return;
        
        const parts = decodedText.split(';');
        if (parts.length >= 6) {
            lastText = decodedText;
            
            const qty = parts[3];
            const freq = sigMap[parts[4]] || "ä¾é†«å›‘æœç”¨";
            const route = routeMap[parts[5]] || "ä¾æŒ‡ç¤ºä½¿ç”¨";

            // UI æ›´æ–°
            document.getElementById('res-qty').innerText = qty + " å–®ä½";
            document.getElementById('res-freq').innerText = freq;
            document.getElementById('res-route').innerText = route;
            document.getElementById('resultCard').style.display = 'block';

            // èªéŸ³å…§å®¹çµ„åˆ (å®Œå…¨ä¸­æ–‡)
            speechMessage = `é€™å€‹è—¥ï¼Œæ¯æ¬¡æœç”¨ ${qty} å–®ä½ã€‚æœç”¨æ™‚é–“æ˜¯ï¼š${freq}ã€‚æœç”¨é€”å¾‘æ˜¯ï¼š${route}ã€‚`;
            speak(speechMessage);

            setTimeout(() => { lastText = ""; }, 5000);
        }
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        // å°‹æ‰¾é«˜å“è³ªä¸­æ–‡èªéŸ³ (Google åœ‹èªæˆ– Premium)
        const voices = window.speechSynthesis.getVoices();
        const chineseVoice = voices.find(v => v.lang.includes('zh-TW') && (v.name.includes('Google') || v.name.includes('Premium'))) 
                            || voices.find(v => v.lang.includes('zh-TW'));
        
        if (chineseVoice) utterance.voice = chineseVoice;
        utterance.lang = 'zh-TW';
        utterance.rate = 0.85; // ç¨æ…¢èªé€Ÿï¼Œè½èµ·ä¾†è¼ƒæ¸…æ¥š
        utterance.pitch = 1.0;
        window.speechSynthesis.speak(utterance);
    }

    function replayAudio() {
        if (speechMessage) speak(speechMessage);
    }
</script>

</body>
</html>
