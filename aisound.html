<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥è¢‹èªéŸ³åŠ©æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --med-teal: #00897b; --med-dark: #004d40; }
        body { background-color: #f0f4f3; font-family: "Microsoft JhengHei", sans-serif; }
        .app-header { background: var(--med-teal); color: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* æƒæå®¹å™¨ï¼šåœ“è§’ä¸”éš±è—æº¢å‡º */
        #scanner-wrapper {
            position: relative;
            width: 100%;
            max-width: 450px;
            aspect-ratio: 1 / 1;
            margin: 20px auto;
            border: 4px solid white;
            border-radius: 24px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        #reader { width: 100%; height: 100%; }

        /* å•Ÿå‹•æŒ‰éˆ•ï¼šè§£æ±ºç€è¦½å™¨å®‰å…¨é™åˆ¶ */
        #start-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
        }

        .result-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: -40px 15px 20px;
            position: relative;
            z-index: 20;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .label { color: #888; font-size: 0.9rem; }
        .value { color: var(--med-dark); font-weight: bold; font-size: 1.3rem; }
    </style>
</head>
<body>

<div class="app-header text-center">
    <h4 class="mb-0">è±åŸé†«é™¢ è—¥è¢‹æƒæåŠ©æ‰‹</h4>
</div>

<div class="container-fluid">
    <div id="scanner-wrapper">
        <div id="reader"></div>
        <button id="start-btn" class="btn btn-primary shadow" onclick="startScanner()">é»æ“Šå•Ÿå‹•ç›¸æ©Ÿ</button>
    </div>

    <div id="resultCard" class="result-card">
        <div class="text-center mb-3">
            <span class="badge rounded-pill bg-success px-3">è§£ææˆåŠŸ</span>
        </div>
        <div class="row text-center">
            <div class="col-6 mb-3">
                <div class="label">æ¯æ¬¡æ•¸é‡</div>
                <div id="res-qty" class="value">-</div>
            </div>
            <div class="col-6 mb-3">
                <div class="label">é€”å¾‘</div>
                <div id="res-route" class="value">-</div>
            </div>
            <div class="col-12 mb-3">
                <div class="label">æœç”¨é »æ¬¡</div>
                <div id="res-freq" class="value">-</div>
            </div>
        </div>
        <button class="btn btn-outline-secondary w-100 mt-2" onclick="replayAudio()">ğŸ”Š é‡è¤‡æœ—è®€</button>
    </div>
</div>

<script>
    const sigMap = { 'QDPC': 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨', 'BID': 'æ¯æ—¥äºŒæ¬¡', 'TID': 'æ¯æ—¥ä¸‰æ¬¡', 'HS': 'ç¡å‰æœç”¨', 'QD': 'æ¯æ—¥ä¸€æ¬¡' };
    const routeMap = { 'PO': 'å£æœ', 'EXT': 'å¤–ç”¨', 'SL': 'èˆŒä¸‹å«æœ' };
    
    let html5QrCode;
    let lastText = "";

    // 1. åˆå§‹åŒ–æƒæå™¨ (é è¨­ç’°å¢ƒé¡é ­)
    function startScanner() {
        document.getElementById('start-btn').style.display = 'none';
        html5QrCode = new Html5Qrcode("reader");
        
        const config = { 
            fps: 20,          // æé«˜æƒæå¹€ç‡ï¼Œè¾¨è­˜æ›´å¿«
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };

        // å¼·åˆ¶ä½¿ç”¨å¾Œç½®é¡é ­ { facingMode: "environment" }
        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess
        ).catch(err => {
            alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦å…è¨±æ¬Šé™");
            document.getElementById('start-btn').style.display = 'block';
        });

        // é ç†±èªéŸ³å¼•æ“ï¼ˆéƒ¨åˆ†ç€è¦½å™¨éœ€è¦ï¼‰
        const msg = new SpeechSynthesisUtterance("");
        window.speechSynthesis.speak(msg);
    }

    // 2. è¾¨è­˜æˆåŠŸé‚è¼¯
    function onScanSuccess(decodedText) {
        // é˜²æ­¢é‡è¦†æƒæåŒä¸€å€‹ç¢¼
        if (decodedText === lastText) return;
        
        const parts = decodedText.split(';');
        if (parts.length >= 6) {
            lastText = decodedText;
            
            const qty = parts[3];
            const freq = sigMap[parts[4]] || parts[4];
            const route = routeMap[parts[5]] || parts[5];

            // UI æ›´æ–°
            document.getElementById('res-qty').innerText = qty + " å–®ä½";
            document.getElementById('res-freq').innerText = freq;
            document.getElementById('res-route').innerText = route;
            document.getElementById('resultCard').style.display = 'block';

            // èªéŸ³çµ„åˆ
            const speechText = `ä½ å¥½ï¼Œé€™å€‹è—¥æ¯æ¬¡æœç”¨ ${qty} å–®ä½ï¼Œæ™‚é–“æ˜¯ ${freq}ï¼Œç”¨ ${route} çš„æ–¹å¼æœç”¨ã€‚`;
            speak(speechText);

            // 5ç§’å¾Œé‡è¨­è¾¨è­˜ç´€éŒ„ï¼Œå…è¨±æƒæä¸‹ä¸€è¢‹è—¥
            setTimeout(() => { lastText = ""; }, 5000);
        }
    }

    // 3. çœŸäººèªéŸ³å„ªåŒ–
    function speak(text) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        // å°‹æ‰¾é«˜å“è³ªä¸­æ–‡èªéŸ³
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.lang.includes('zh-TW') && (v.name.includes('Google') || v.name.includes('Premium'))) 
                              || voices.find(v => v.lang.includes('zh-TW'));
        
        if (preferredVoice) utterance.voice = preferredVoice;
        utterance.lang = 'zh-TW';
        utterance.rate = 0.85;  // æ…¢é€Ÿæ›´æ¸…æ™°
        utterance.pitch = 1.1;   // æé«˜éŸ³èª¿å¢åŠ è¦ªå’ŒåŠ›
        window.speechSynthesis.speak(utterance);
    }

    function replayAudio() {
        if (lastText) onScanSuccess(lastText);
    }
</script>

</body>
</html>
