<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥è¢‹å¤šèªèªéŸ³åŠ©æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --med-teal: #00796b; }
        body { background-color: #f1f3f4; font-family: sans-serif; }
        .app-header { background: var(--med-teal); color: white; padding: 15px; text-align: center; }
        .container-box { max-width: 500px; margin: auto; padding: 15px; }
        #reader { width: 100%; border-radius: 20px; overflow: hidden; background: #000; }
        .result-card { background: white; border-radius: 20px; padding: 20px; margin-top: 20px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .label { color: #666; font-size: 0.85rem; }
        .value { color: #004d40; font-weight: bold; font-size: 1.3rem; }
    </style>
</head>
<body>

<div class="app-header"><h5>è—¥è¢‹èªéŸ³è¼”åŠ© (å¤šèªç‰ˆ)</h5></div>

<div class="container-box">
    <div class="card p-3 mb-3">
        <label class="label mb-2">é¸æ“‡èªéŸ³èªè¨€ (Language):</label>
        <select id="langSelect" class="form-select form-select-lg">
            <option value="zh-TW">ä¸­æ–‡ (åœ‹èª)</option>
            <option value="nan-TW" selected>å°èª (è‹±æ–‡æ‹¼éŸ³æ¨¡æ“¬)</option>
            <option value="en-US">English (è‹±æ–‡)</option>
            <option value="vi-VN">Tiáº¿ng Viá»‡t (è¶Šå—æ–‡)</option>
            <option value="id-ID">Bahasa Indonesia (å°å°¼æ–‡)</option>
            <option value="th-TH">à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ (æ³°æ–‡)</option>
        </select>
    </div>

    <div id="reader"></div>
    <div class="text-center mt-3">
        <button id="start-btn" class="btn btn-primary px-5 py-2 rounded-pill" onclick="startScanner()">å•Ÿå‹•æƒæå™¨</button>
    </div>

    <div id="resultCard" class="result-card">
        <div class="mb-3">
            <div class="label">æœç”¨é€”å¾‘ (Route)</div>
            <div id="res-route" class="value">-</div>
        </div>
        <div>
            <div class="label">æœç”¨æ™‚é–“ (Frequency)</div>
            <div id="res-freq" class="value">-</div>
        </div>
        <button class="btn btn-outline-secondary w-100 mt-3" onclick="replayAudio()">ğŸ”Š é‡æ–°æ’­æ”¾</button>
    </div>
</div>

<script>
    // æ‹¼éŸ³å°ç…§è¡¨
    const translations = {
        'zh-TW': {
            lang: 'zh-TW', welcome: 'æ‚¨å¥½ï¼Œé€™å€‹è—¥', use: 'æ–¹å¼æ˜¯',
            'QDPC': { display: 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨', speech: 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨' },
            'PO': { display: 'å£æœ', speech: 'å£æœ' }
        },
        'nan-TW': { 
            lang: 'en-US', // ä½¿ç”¨è‹±æ–‡å¼•æ“ä¾†è®€æ‹¼éŸ³
            welcome: 'Li-ho, Jiy-kuan yo-ah', // å“©åšï¼Œé€™æ¬¾è—¥ä»”
            use: 'chi-ah h-ah shi',            // é£Ÿæ³•æ˜¯
            'QDPC': { display: 'é€å·¥ä¸€æ”¹ï¼Œé£Ÿé£½æ‰é£Ÿ', speech: 'Tak-kang chit-kai, chiah-pah chiah chiah' },
            'BID': { display: 'é€å·¥å…©æ”¹', speech: 'Tak-kang n-ng kai' },
            'TID': { display: 'é€å·¥ä¸‰æ”¹', speech: 'Tak-kang sha-ah kai' },
            'HS': { display: 'æ¬²æ„›çå‰é£Ÿ', speech: 'Beh-khun shin chiah' },
            'PO': { display: 'ç”¨é£Ÿçš„', speech: 'yong chiah eh' },
            'EXT': { display: 'å¤–ç”¨', speech: 'guah-yong eh' }
        },
        'en-US': {
            lang: 'en-US', welcome: 'Hello, this medicine', use: 'Take it by',
            'QDPC': { display: 'Once daily after meals', speech: 'Once daily after meals' },
            'PO': { display: 'Oral', speech: 'Oral' }
        }
    };

    let html5QrCode;
    let lastText = "";
    let speechQueue = { text: "", lang: "" };

    function startScanner() {
        document.getElementById('start-btn').style.display = 'none';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, onScanSuccess);
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
    }

    function onScanSuccess(decodedText) {
        if (decodedText === lastText) return;
        const parts = decodedText.split(';');
        if (parts.length >= 6) {
            lastText = decodedText;
            const langKey = document.getElementById('langSelect').value;
            const dict = translations[langKey] || translations['zh-TW'];

            const freqObj = dict[parts[4]] || { display: parts[4], speech: parts[4] };
            const routeObj = dict[parts[5]] || { display: parts[5], speech: parts[5] };

            document.getElementById('res-freq').innerText = freqObj.display;
            document.getElementById('res-route').innerText = routeObj.display;
            document.getElementById('resultCard').style.display = 'block';

            // çµ„åˆèªéŸ³
            const speechText = `${dict['welcome']}, ${freqObj.speech}, ${dict['use']}, ${routeObj.speech}`;
            speechQueue = { text: speechText, lang: dict.lang };
            
            speak(speechQueue.text, speechQueue.lang);
            setTimeout(() => { lastText = ""; }, 5000);
        }
    }

    function speak(text, lang) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        utterance.rate = 0.75; // æ‹¼éŸ³è®€æ³•å»ºè­°èªé€Ÿæ›´æ…¢ä¸€é»
        utterance.pitch = 1.0;
        window.speechSynthesis.speak(utterance);
    }

    function replayAudio() {
        if (speechQueue.text) speak(speechQueue.text, speechQueue.lang);
    }
</script>
</body>
</html>
