<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥è¢‹èªéŸ³ç³»çµ± - è±åŸé†«é™¢ä¿®æ­£ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --med-teal: #00796b; --med-dark: #004d40; }
        body { background-color: #f1f3f4; font-family: "PingFang TC", sans-serif; }
        .app-header { background: var(--med-teal); color: white; padding: 15px; text-align: center; }

        /* æƒæå€åŸŸèˆ‡æ–¹æ¡† */
        #scanner-wrapper {
            position: relative; width: 100%; max-width: 450px; aspect-ratio: 1 / 1;
            margin: 10px auto; background: #000; overflow: hidden; border-radius: 20px;
        }
        .scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            background: rgba(0, 0, 0, 0.4);
            -webkit-mask: radial-gradient(circle, transparent 125px, black 125px);
            mask: radial-gradient(circle, transparent 125px, black 125px);
        }
        .scan-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 250px; height: 250px; border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px; z-index: 11; pointer-events: none;
        }
        .scan-box::before, .scan-box::after { content: ""; position: absolute; width: 30px; height: 30px; border: 4px solid #00ffcc; }
        .corner-tl { top: -2px; left: -2px; border-right: none; border-bottom: none; border-top-left-radius: 12px; }
        .corner-tr { top: -2px; right: -2px; border-left: none; border-bottom: none; border-top-right-radius: 12px; }
        .corner-bl { bottom: -2px; left: -2px; border-right: none; border-top: none; border-bottom-left-radius: 12px; }
        .corner-br { bottom: -2px; right: -2px; border-left: none; border-top: none; border-bottom-right-radius: 12px; }

        .lang-selector { background: white; border-radius: 15px; padding: 15px; margin: 10px; }
        .result-card {
            background: white; border-radius: 20px; padding: 25px; margin: 10px;
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--med-teal);
        }
        .label { color: #666; font-size: 0.85rem; }
        .value { color: var(--med-dark); font-weight: bold; font-size: 1.4rem; }
        #start-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; }
    </style>
</head>
<body>

<div class="app-header"><h5>è—¥è¢‹èªéŸ³æƒæç³»çµ±</h5></div>

<div class="lang-selector">
    <label class="label mb-2">è«‹é¸æ“‡èªè¨€ (Select Language):</label>
    <select id="langSelect" class="form-select form-select-lg">
        <option value="zh-TW">ä¸­æ–‡ (åœ‹èª)</option>
        <option value="nan-TW" selected>å°èª (è‹±æ–‡æ‹¼éŸ³æ¨¡æ“¬)</option>
        <option value="vi-VN">Tiáº¿ng Viá»‡t (è¶Šå—æ–‡)</option>
        <option value="id-ID">Bahasa Indonesia (å°å°¼æ–‡)</option>
        <option value="th-TH">à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ (æ³°æ–‡)</option>
        <option value="en-US">English (è‹±æ–‡)</option>
    </select>
</div>

<div id="scanner-wrapper">
    <div id="reader"></div>
    <div class="scan-overlay"></div>
    <div class="scan-box">
        <div class="corner-tl"></div><div class="corner-tr"></div>
        <div class="corner-bl"></div><div class="corner-br"></div>
    </div>
    <button id="start-btn" class="btn btn-primary btn-lg px-4" onclick="startScanner()">é»æ“Šå•Ÿå‹•ç›¸æ©Ÿ</button>
</div>

<div id="resultCard" class="result-card">
    <div class="mb-3">
        <div class="label">æœç”¨é€”å¾‘ (Route)</div>
        <div id="res-route" class="value">-</div>
    </div>
    <div>
        <div class="label">æœç”¨æ™‚é–“ (Frequency)</div>
        <div id="res-freq" class="value">-</div>
    </div>
    <button class="btn btn-outline-secondary w-100 mt-4" onclick="replayAudio()">ğŸ”Š é‡æ–°æ’­æ”¾</button>
</div>

<script>
    const translations = {
        'zh-TW': { engine: 'zh', welcome: 'æ‚¨å¥½ï¼Œé€™å€‹è—¥', use: 'æ–¹å¼æ˜¯', 'QDPC': { d: 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨', s: 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨' }, 'PO': { d: 'å£æœ', s: 'å£æœ' } },
        'nan-TW': { engine: 'en', welcome: 'Li-ho, Jiy-kuan yo-ah', use: 'chi-ah h-ah shi', 'QDPC': { d: 'é€å·¥ä¸€æ”¹ï¼Œé£Ÿé£½æ‰é£Ÿ', s: 'Tak-kang chit-kai, chiah-pah chiah chiah' }, 'BID': { d: 'é€å·¥å…©æ”¹', s: 'Tak-kang n-ng kai' }, 'PO': { d: 'ç”¨é£Ÿçš„', s: 'yong chiah eh' } },
        'vi-VN': { engine: 'vi', welcome: 'Xin chÃ o, thuá»‘c nÃ y', use: 'cÃ¡ch dÃ¹ng lÃ ', 'QDPC': { d: 'Má»—i ngÃ y má»™t láº§n sau khi Äƒn', s: 'Má»—i ngÃ y má»™t láº§n sau khi Äƒn' }, 'PO': { d: 'ÄÆ°á»ng uá»‘ng', s: 'ÄÆ°á»ng uá»‘ng' } },
        'id-ID': { engine: 'id', welcome: 'Halo, obat ini', use: 'cara pakainya', 'QDPC': { d: 'Sekali sehari setelah makan', s: 'Sekali sehari setelah makan' }, 'PO': { d: 'Diminum', s: 'Diminum' } },
        'th-TH': { engine: 'th', welcome: 'à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸° à¸¢à¸²à¸•à¸±à¸§à¸™à¸µà¹‰', use: 'à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¸„à¸·à¸­', 'QDPC': { d: 'à¸§à¸±à¸™à¸¥à¸°à¸«à¸™à¸¶à¹ˆà¸‡à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£', s: 'à¸§à¸±à¸™à¸¥à¸°à¸«à¸™à¸¶à¹ˆà¸‡à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£' }, 'PO': { d: 'à¸£à¸±à¸šà¸›à¸£à¸°à¸—à¸²à¸™', s: 'à¸£à¸±à¸šà¸›à¸£à¸°à¸—à¸²à¸™' } },
        'en-US': { engine: 'en', welcome: 'Hello, this medicine', use: 'way to use is', 'QDPC': { d: 'Once daily after meals', s: 'Once daily after meals' }, 'PO': { d: 'Oral', s: 'Oral' } }
    };

    let html5QrCode;
    let lastText = "";
    let currentSpeech = { text: "", lang: "" };

    function startScanner() {
        document.getElementById('start-btn').style.display = 'none';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 250, height: 250 } }, onScanSuccess);
        
        // é—œéµï¼šå•Ÿå‹•æ™‚å…ˆè¼‰å…¥èªéŸ³åŒ…ï¼ˆä¿®æ­£ iOS/Chrome ä¸ç™¼è²æˆ–èªéŸ³è·‘æ‰çš„å•é¡Œï¼‰
        window.speechSynthesis.getVoices();
        const silence = new SpeechSynthesisUtterance("");
        window.speechSynthesis.speak(silence);
    }

    function onScanSuccess(decodedText) {
        if (decodedText === lastText) return;
        const parts = decodedText.split(';');
        if (parts.length >= 6) {
            lastText = decodedText;
            const langKey = document.getElementById('langSelect').value;
            const dict = translations[langKey] || translations['zh-TW'];

            const freq = dict[parts[4]] || { d: parts[4], s: parts[4] };
            const route = dict[parts[5]] || { d: parts[5], s: parts[5] };

            document.getElementById('res-freq').innerText = freq.d;
            document.getElementById('res-route').innerText = route.d;
            document.getElementById('resultCard').style.display = 'block';

            currentSpeech.text = `${dict.welcome}, ${freq.s}, ${dict.use}, ${route.s}`;
            currentSpeech.lang = dict.engine; // å‚³é€å¼•æ“é—œéµå­— (zh, en, vi...)
            
            speak(currentSpeech.text, currentSpeech.lang);
            setTimeout(() => { lastText = ""; }, 5000);
        }
    }

    function speak(text, engineKey) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        // å¼·åˆ¶æœå°‹åŒ¹é…çš„èªéŸ³å¼•æ“
        const voices = window.speechSynthesis.getVoices();
        const targetVoice = voices.find(v => v.lang.toLowerCase().startsWith(engineKey.toLowerCase()));
        
        if (targetVoice) {
            utterance.voice = targetVoice;
            utterance.lang = targetVoice.lang;
        } else {
            // å¦‚æœæ‰¾ä¸åˆ°ç‰¹å®šå¼•æ“ï¼Œè‡³å°‘è¨­å®šèªç³»ä»£ç¢¼
            utterance.lang = engineKey === 'en' ? 'en-US' : (engineKey === 'zh' ? 'zh-TW' : engineKey);
        }

        utterance.rate = (engineKey === 'en') ? 0.75 : 0.85; // è‹±æ–‡æ‹¼éŸ³è®€å°èªæ™‚æ”¾æ…¢
        window.speechSynthesis.speak(utterance);
    }

    function replayAudio() {
        if (currentSpeech.text) speak(currentSpeech.text, currentSpeech.lang);
    }

    // è§£æ±º Chrome èªéŸ³è¼‰å…¥å»¶é²çš„ç›£è½
    window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); };
</script>
</body>
</html>
