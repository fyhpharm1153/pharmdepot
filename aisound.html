<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥è¢‹èªéŸ³ç³»çµ± - è±åŸé†«é™¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --med-teal: #00796b; }
        body { background-color: #f4f7f6; font-family: "PingFang TC", sans-serif; }
        .app-header { background: var(--med-teal); color: white; padding: 12px; text-align: center; }
        
        /* ç¸®å°ä¸”æ¸…æ¥šçš„æƒæå€åŸŸ */
        #scanner-container {
            width: 280px; height: 280px;
            margin: 20px auto;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }

        .lang-section { padding: 0 20px; }
        .result-card {
            background: white; border-radius: 20px; padding: 20px; margin: 15px;
            display: none; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .info-row { border-bottom: 1px solid #eee; padding: 10px 0; }
        .label { color: #888; font-size: 0.85rem; }
        .value { color: #333; font-weight: bold; font-size: 1.1rem; }
        
        .btn-calendar {
            background-color: #4285F4; color: white; border: none;
            width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; margin-top: 10px;
        }
        #start-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; }
    </style>
</head>
<body>

<div class="app-header"><h6>è—¥è¢‹è‡ªå‹•æƒæè¼”åŠ©ç³»çµ±</h6></div>

<div class="lang-section mt-3">
    <select id="langSelect" class="form-select">
        <option value="zh-TW">åœ‹èª (Standard Mandarin)</option>
        <option value="nan-TW" selected>å°èª (æ¨¡æ“¬è«§éŸ³ - è‹±æ–‡å¼•æ“)</option>
        <option value="vi-VN">Tiáº¿ng Viá»‡t (è¶Šå—æ–‡)</option>
        <option value="id-ID">Bahasa Indonesia (å°å°¼æ–‡)</option>
        <option value="th-TH">à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ (æ³°æ–‡)</option>
    </select>
</div>

<div id="scanner-container">
    <div id="reader"></div>
    <button id="start-btn" class="btn btn-primary" onclick="startScanner()">é–‹å•Ÿç›¸æ©Ÿ</button>
</div>

<div id="resultCard" class="result-card">
    <div class="info-row">
        <div class="label">æœç”¨é€”å¾‘</div>
        <div id="res-route" class="value">-</div>
    </div>
    <div class="info-row">
        <div class="label">æœç”¨é »æ¬¡</div>
        <div id="res-freq" class="value">-</div>
    </div>
    
    <button class="btn btn-outline-secondary w-100 mt-3" onclick="replayAudio()">ğŸ”Š é‡æ–°æ’­æ”¾èªéŸ³</button>
    
    <button id="calBtn" class="btn-calendar" style="display: none;">ğŸ“… åŠ å…¥æˆ‘çš„è¡Œäº‹æ›†æé†’</button>
</div>

<script>
    const translations = {
        'zh-TW': { engine: 'zh', welcome: 'æ‚¨å¥½ï¼Œé€™å€‹è—¥', use: 'æ–¹å¼æ˜¯', 'QDPC': { d: 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨', s: 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨' }, 'PO': { d: 'å£æœ', s: 'å£æœ' } },
        'nan-TW': { engine: 'en', welcome: 'Li-ho, Jiy-kuan yo-ah', use: 'chi-ah h-ah shi', 'QDPC': { d: 'é€å·¥ä¸€æ”¹ï¼Œé£Ÿé£½æ‰é£Ÿ', s: 'Tak-kang chit-kai, chiah-pah chiah chiah' }, 'PO': { d: 'ç”¨é£Ÿçš„', s: 'yong chiah eh' } },
        'vi-VN': { engine: 'vi', welcome: 'Xin chÃ o, thuá»‘c nÃ y', use: 'cÃ¡ch dÃ¹ng lÃ ', 'QDPC': { d: 'Má»—i ngÃ y má»™t láº§n sau khi Äƒn', s: 'Má»—i ngÃ y má»™t láº§n sau khi Äƒn' }, 'PO': { d: 'ÄÆ°á»ng uá»‘ng', s: 'ÄÆ°á»ng uá»‘ng' } },
        'id-ID': { engine: 'id', welcome: 'Halo, obat ini', use: 'cara pakainya', 'QDPC': { d: 'Sekali sehari setelah makan', s: 'Sekali sehari setelah makan' }, 'PO': { d: 'Diminum', s: 'Diminum' } }
    };

    let html5QrCode;
    let lastText = "";
    let currentData = { date: "", days: "", freqText: "" };

    function startScanner() {
        document.getElementById('start-btn').style.display = 'none';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, onScanSuccess);
        window.speechSynthesis.getVoices();
    }

    function onScanSuccess(decodedText) {
        if (decodedText === lastText) return;
        const parts = decodedText.split(';');
        
        if (parts.length >= 7) {
            lastText = decodedText;
            const langKey = document.getElementById('langSelect').value;
            const dict = translations[langKey] || translations['zh-TW'];

            // æŠ“å–é—œéµè³‡è¨Šï¼šæ—¥æœŸ (index 1), é »æ¬¡ (index 4), é€”å¾‘ (index 5), å¤©æ•¸ (index 6)
            const rawDate = parts[1]; // yyyymmdd
            const freqCode = parts[4];
            const routeCode = parts[5];
            const totalDays = parts[6];

            const freq = dict[freqCode] || { d: freqCode, s: freqCode };
            const route = dict[routeCode] || { d: routeCode, s: routeCode };

            // å„²å­˜è³‡è¨Šä¾›è¡Œäº‹æ›†ä½¿ç”¨
            currentData = { date: rawDate, days: totalDays, freqText: freq.d };

            // æ›´æ–°ä»‹é¢
            document.getElementById('res-freq').innerText = freq.d;
            document.getElementById('res-route').innerText = route.d;
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('calBtn').style.display = 'block';
            document.getElementById('calBtn').onclick = () => addToCalendar(currentData);

            // èªéŸ³æ’­æ”¾
            const speechText = `${dict.welcome}, ${freq.s}, ${dict.use}, ${route.s}`;
            speak(speechText, dict.engine);

            setTimeout(() => { lastText = ""; }, 5000);
        }
    }

    // è¡Œäº‹æ›†é€£çµç”¢ç”Ÿå™¨ (Google Calendar)
    function addToCalendar(data) {
        const year = data.date.substring(0, 4);
        const month = data.date.substring(4, 6);
        const day = data.date.substring(6, 8);
        
        // å‡è¨­å¾ç•¶å¤©æ—©ä¸Š 9 é»é–‹å§‹æé†’
        const start = `${year}${month}${day}T090000`;
        const end = `${year}${month}${day}T093000`;
        
        // è¨­å®šé‡è¤‡è¦å‰‡ï¼šå¤©æ•¸ (ä¾‹å¦‚ 7 å¤©)
        const rrule = `RRULE:FREQ=DAILY;COUNT=${data.days}`;
        
        const gCalUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent("æœç”¨è—¥ç‰©æé†’ (" + data.freqText + ")")}&dates=${start}/${end}&details=${encodeURIComponent("è«‹è¨˜å¾—ä¾é†«å›‘æœç”¨è—¥ç‰©ã€‚å¤©æ•¸ï¼š" + data.days + "å¤©")}&recur=${encodeURIComponent(rrule)}&sf=true&output=xml`;
        
        window.open(gCalUrl, '_blank');
    }

    function speak(text, engineKey) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const targetVoice = voices.find(v => v.lang.toLowerCase().startsWith(engineKey.toLowerCase()));
        
        if (targetVoice) utterance.voice = targetVoice;
        utterance.lang = (engineKey === 'en') ? 'en-US' : (engineKey === 'zh' ? 'zh-TW' : engineKey);
        utterance.rate = (engineKey === 'en') ? 0.75 : 0.85;
        window.speechSynthesis.speak(utterance);
    }

    function replayAudio() {
        const langKey = document.getElementById('langSelect').value;
        const parts = lastText.split(';');
        if (parts.length >= 6) {
            const dict = translations[langKey] || translations['zh-TW'];
            const freq = dict[parts[4]] || { s: parts[4] };
            const route = dict[parts[5]] || { s: parts[5] };
            speak(`${dict.welcome}, ${freq.s}, ${dict.use}, ${route.s}`, dict.engine);
        }
    }
</script>
</body>
</html>
