<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§è—¥è¢‹èªéŸ³åŠ©æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --medical-green: #2a9d8f;
            --dark-blue: #264653;
        }
        body { background-color: #f8f9fa; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        
        /* æƒæå€åŸŸç¾åŒ– */
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        /* çµæœå¡ç‰‡è¨­è¨ˆ */
        .result-box {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-top: -30px;
            position: relative;
            z-index: 10;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: none;
        }
        
        .status-badge {
            background-color: var(--medical-green);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 10px;
        }

        .med-info { font-size: 1.5rem; font-weight: 800; color: var(--dark-blue); }
        .btn-replay {
            background: var(--dark-blue);
            color: white;
            border-radius: 12px;
            width: 100%;
            padding: 12px;
            font-weight: bold;
            border: none;
            transition: 0.3s;
        }
        .btn-replay:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div class="container-fluid p-0">
    <div class="bg-dark p-3 text-center text-white">
        <h5 class="m-0">è‡ªå‹•æƒæè—¥è¢‹è¼”åŠ©</h5>
    </div>

    <div id="scanner-container">
        <div id="reader" style="width: 100%;"></div>
    </div>

    <div class="container">
        <div id="resultCard" class="result-box mx-auto">
            <div class="text-center">
                <span class="status-badge">æƒææˆåŠŸ</span>
                <div class="med-info" id="display-text">è¼‰å…¥ä¸­...</div>
                <hr>
                <div class="row text-start mb-3">
                    <div class="col-6 text-muted">æœç”¨æ•¸é‡ï¼š<span class="text-dark fw-bold" id="res-qty"></span></div>
                    <div class="col-6 text-muted">é€”å¾‘ï¼š<span class="text-dark fw-bold" id="res-route"></span></div>
                    <div class="col-12 text-muted mt-2">æ™‚é–“ï¼š<span class="text-dark fw-bold" id="res-freq"></span></div>
                </div>
                <button class="btn btn-replay" onclick="replay()">ğŸ”Š é‡æ–°æœ—è®€ä¸€æ¬¡</button>
            </div>
        </div>
        
        <div class="text-center mt-4 p-3 text-muted" style="font-size: 0.85rem;">
            å°‡è—¥è¢‹ä¸Šçš„ QR Code æ”¾å…¥æ–¹æ¡†å…§å³å¯è‡ªå‹•è¾¨è­˜
        </div>
    </div>
</div>

<script>
    const sigMap = { 'QDPC': 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨', 'BID': 'æ¯æ—¥äºŒæ¬¡', 'TID': 'æ¯æ—¥ä¸‰æ¬¡', 'HS': 'ç¡å‰æœç”¨' };
    const routeMap = { 'PO': 'å£æœ', 'EXT': 'å¤–ç”¨' };
    let currentVoice = null;
    let lastParsedText = "";

    // 1. åˆå§‹åŒ–é«˜å“è³ªèªéŸ³
    function initVoice() {
        const voices = window.speechSynthesis.getVoices();
        // å„ªå…ˆå°‹æ‰¾ Google åœ‹èªã€Microsoft Hanhan æˆ–ä»»ä½•æ¨™è¨»ç‚º "Premium" çš„ä¸­æ–‡èªéŸ³
        currentVoice = voices.find(v => v.lang.includes('zh-TW') && (v.name.includes('Google') || v.name.includes('Premium'))) 
                       || voices.find(v => v.lang.includes('zh-TW'))
                       || voices.find(v => v.lang.includes('zh-CN'));
    }
    // ç›£è½èªéŸ³è¼‰å…¥ï¼ˆChrome éœ€è¦ï¼‰
    window.speechSynthesis.onvoiceschanged = initVoice;

    // 2. æœ—è®€åŠŸèƒ½é‚è¼¯
    function speak(text) {
        window.speechSynthesis.cancel(); // å…ˆåœæ­¢ä¹‹å‰çš„èªéŸ³
        const msg = new SpeechSynthesisUtterance(text);
        if (currentVoice) msg.voice = currentVoice;
        
        msg.lang = 'zh-TW';
        msg.rate = 0.85;  // ç¨æ…¢çš„èªé€Ÿè½èµ·ä¾†æ¯”è¼ƒæº«å’Œä¸”æ¸…æ™°
        msg.pitch = 1.05; // ç¨å¾®èª¿é«˜éŸ³èª¿ï¼Œè½èµ·ä¾†æ¯”è¼ƒä¸åƒæ©Ÿå™¨äºº
        window.speechSynthesis.speak(msg);
    }

    // 3. æƒææˆåŠŸå›å‘¼
    function onScanSuccess(decodedText) {
        const parts = decodedText.split(';');
        if (parts.length >= 6) {
            const qty = parts[3];
            const freq = sigMap[parts[4]] || parts[4];
            const route = routeMap[parts[5]] || parts[5];

            // æ›´æ–°ä»‹é¢
            document.getElementById('res-qty').innerText = qty + " å–®ä½";
            document.getElementById('res-freq').innerText = freq;
            document.getElementById('res-route').innerText = route;
            document.getElementById('display-text').innerText = `${freq}`;
            document.getElementById('resultCard').style.display = 'block';

            // çµ„åˆèªéŸ³å¥å­
            lastParsedText = `é€™å€‹è—¥ï¼Œæ¯æ¬¡æœç”¨ ${qty} å–®ä½ï¼Œ${freq}ï¼Œ${route}ã€‚`;
            speak(lastParsedText);

            // åœæ­¢æƒæ 3 ç§’ï¼Œé¿å…é‡è¤‡è§¸ç™¼
            html5QrcodeScanner.pause(true);
            setTimeout(() => { html5QrcodeScanner.resume(); }, 3000);
        }
    }

    function replay() { if(lastParsedText) speak(lastParsedText); }

    // 4. å•Ÿå‹•ç›¸æ©Ÿæƒæ
    const html5QrcodeScanner = new Html5QrcodeScanner("reader", { 
        fps: 15, 
        qrbox: { width: 250, height: 250 },
        rememberLastUsedCamera: true,
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA] // å¼·åˆ¶ä½¿ç”¨ç›¸æ©Ÿ
    });
    html5QrcodeScanner.render(onScanSuccess);

</script>
</body>
</html>
