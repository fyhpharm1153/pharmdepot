<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è—¥è¢‹èªéŸ³æƒæåŠ©æ‰‹ - è±åŸé†«é™¢ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-color: #00796b; /* é†«é™¢é«”ç³»ç¶ è‰² */
            --secondary-color: #004d40;
            --bg-light: #f4f7f6;
        }
        body {
            background-color: var(--bg-light);
            font-family: "Microsoft JhengHei", sans-serif;
        }
        .header-banner {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #reader {
            border: 2px solid var(--primary-color) !important;
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }
        .result-card {
            display: none;
            margin-top: 20px;
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .info-label {
            color: #666;
            font-size: 0.9rem;
        }
        .info-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        .btn-speak {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50px;
            padding: 10px 30px;
        }
        .btn-speak:hover {
            background-color: var(--secondary-color);
            color: white;
        }
    </style>
</head>
<body>

<div class="header-banner text-center">
    <h3>ğŸ’Š è—¥è¢‹èªéŸ³è¼”åŠ©ç³»çµ±</h3>
    <p class="mb-0">è«‹å°æº–è—¥è¢‹ä¸Šçš„ QR Code é€²è¡Œæƒæ</p>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div id="reader"></div>

            <div id="resultCard" class="card result-card">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">æƒæçµæœ</h5>
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="info-label">æ¯æ¬¡åŠ‘é‡</div>
                            <div id="val-dose" class="info-value">-</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="info-label">æœç”¨é€”å¾‘</div>
                            <div id="val-route" class="info-value">-</div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="info-label">æœç”¨é »æ¬¡</div>
                            <div id="val-freq" class="info-value">-</div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-speak" onclick="replayAudio()">
                            ğŸ”Š é‡æ–°æ’­æ”¾èªéŸ³
                        </button>
                    </div>
                </div>
            </div>
            
            <p class="text-muted text-center mt-4" style="font-size: 0.8rem;">
                * æœ¬ç³»çµ±åƒ…ä¾›è¼”åŠ©ï¼Œç”¨è—¥è«‹å‹™å¿…éµç…§è—¥è¢‹æ¨™ç¤ºèˆ‡è—¥å¸«æŒ‡ç¤ºã€‚
            </p>
        </div>
    </div>
</div>

<script>
    // 1. é†«å›‘ç¸®å¯«å°æ‡‰è¡¨ (SIG & Route)
    const sigMap = {
        'QD': 'æ¯æ—¥ä¸€æ¬¡',
        'QDPC': 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å¾Œæœç”¨',
        'QDAC': 'æ¯æ—¥ä¸€æ¬¡ï¼Œé£¯å‰æœç”¨',
        'BID': 'æ¯æ—¥äºŒæ¬¡',
        'TID': 'æ¯æ—¥ä¸‰æ¬¡',
        'QID': 'æ¯æ—¥å››æ¬¡',
        'HS': 'ç¡å‰æœç”¨',
        'QN': 'æ¯æ™šä¸€æ¬¡',
        'QOD': 'æ¯éš”ä¸€å¤©ä¸€æ¬¡',
        'PRN': 'éœ€è¦æ™‚æœç”¨'
    };

    const routeMap = {
        'PO': 'å£æœ',
        'EXT': 'å¤–ç”¨',
        'SL': 'èˆŒä¸‹å«æœ',
        'EYE': 'é»çœ¼',
        'EAR': 'é»è€³'
    };

    let lastMessage = ""; // å„²å­˜æœ€å¾Œä¸€æ¬¡è§£æçš„æ–‡å­—

    // 2. åˆå§‹åŒ–æƒæå™¨
    function onScanSuccess(decodedText) {
        // æ ¼å¼: 2574;20260105;0000841320;1;QDPC;PO;7;0;...
        const parts = decodedText.split(';');
        
        if (parts.length >= 6) {
            const dose = parts[3];                // æ¯æ¬¡æœç”¨æ•¸é‡
            const freq = sigMap[parts[4]] || parts[4]; // é »æ¬¡
            const route = routeMap[parts[5]] || parts[5]; // é€”å¾‘

            // æ›´æ–°ä»‹é¢
            document.getElementById('val-dose').innerText = dose + " å–®ä½";
            document.getElementById('val-freq').innerText = freq;
            document.getElementById('val-route').innerText = route;
            document.getElementById('resultCard').style.display = 'block';

            // çµ„åˆèªéŸ³å­—ä¸²
            lastMessage = `æ¯æ¬¡æœç”¨ ${dose} å–®ä½ã€‚ ${freq}ã€‚ ${route}ã€‚`;
            speak(lastMessage);

            // æš«åœæƒæä¸€é™£å­ï¼Œé¿å…é‡è¤‡è®€å–
            html5QrcodeScanner.clear();
            setTimeout(() => {
                html5QrcodeScanner.render(onScanSuccess);
            }, 5000);
        }
    }

    // 3. èªéŸ³æœ—è®€åŠŸèƒ½
    function speak(text) {
        // å…ˆå–æ¶ˆæ‰€æœ‰æ­£åœ¨é€²è¡Œçš„èªéŸ³
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.rate = 0.9; // èªé€Ÿç¨æ…¢ä¸€é»ï¼Œè½å¾—æ¯”è¼ƒæ¸…æ¥š
        utterance.pitch = 1.0;
        window.speechSynthesis.speak(utterance);
    }

    function replayAudio() {
        if (lastMessage) speak(lastMessage);
    }

    // å•Ÿå‹•æƒæå™¨
    const html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: { width: 250, height: 250 } }
    );
    html5QrcodeScanner.render(onScanSuccess);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
